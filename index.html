<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEI Controle Total</title>
    
    <!-- Bibliotecas de Estilo -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bibliotecas para PDF e Word -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- FIREBASE SDK (COMPAT V9) - Versão estável para arquivo único -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --primary: #00bf63;
            --primary-dark: #00914b;
            --secondary: #5e17eb;
            --bg-light: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--text-main); height: 100vh; overflow-x: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-dark { background: var(--text-main); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 6px 10px; font-size: 0.85rem; width: auto; margin: 0; }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }

        /* Login */
        #auth-screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: var(--surface); position: fixed; top: 0; width: 100%; z-index: 9999; }
        
        .auth-input { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; 
            border: 1px solid #cbd5e1; background: #f8fafc; font-size: 0.95rem; color: #333; transition: all 0.2s ease;
        }
        .auth-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(0, 191, 99, 0.15); }
        
        /* App */
        #app-screen { padding-bottom: 90px; }
        header { background: var(--surface); padding: 15px 0; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .text-green { color: var(--primary); }
        .text-red { color: var(--danger); }
        .text-warn { color: var(--warning); }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); padding: 10px 0; display: flex; justify-content: space-around; z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; background: none; border: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 600; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block; margin-top: 10px; font-weight: 500; }
        
        .type-switch { display: flex; background: var(--bg-light); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .type-opt { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .type-opt.active.inc { background: var(--primary); color: white; }
        .type-opt.active.exp { background: var(--danger); color: white; }
        
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: var(--bg-light); border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 0.9rem; }
        .tab-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }

        .app-footer { text-align: center; margin-top: 30px; margin-bottom: 20px; font-size: 0.8rem; color: var(--text-muted); padding: 10px; border-top: 1px solid var(--border); }
        .contact-links { display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 1.2rem; }
        .contact-links a { color: var(--text-main); transition: 0.2s; }
        
        .donation-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 0.8rem; border: 1px dashed var(--primary); }
        .badge-stock { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .stock-ok { color: var(--primary-dark); background: #dcfce7; }
        .stock-low { color: #b45309; background: #fef3c7; }
        .stock-crit { color: #991b1b; background: #fee2e2; }

        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        .radio-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .radio-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        .radio-item input { width: 18px; height: 18px; accent-color: var(--primary); }

        .alert-das { padding: 12px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem; text-align: center; font-weight: 600; }
        .das-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .das-urgent { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .pix-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn-pix { padding: 15px; border: 2px solid var(--primary); background: white; border-radius: 12px; cursor: pointer; font-weight: 600; color: var(--text-main); transition: 0.2s; font-size: 1rem; }
        .btn-pix:active { background: var(--primary); color: white; transform: scale(0.98); }
        .pix-feedback { margin-top: 15px; padding: 12px; background: #dcfce7; color: var(--primary-dark); border-radius: 8px; font-size: 0.9rem; font-weight: 600; display: none; border: 1px solid #86efac; }
        .pix-display-area { background: #f9f9f9; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.75rem; color: #555; margin-top: 10px; word-break: break-all; display: none; user-select: all; border: 1px solid #ddd; }
        
        .rpa-results { background: #f8fafc; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px solid var(--border); }
        .rpa-line { display: flex; justify-content: space-between; padding: 5px 0; font-size: 0.9rem; border-bottom: 1px dashed #eee; }

        .irrf-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .irrf-table th { text-align: left; padding: 5px; background: #eee; }
        .irrf-table td { padding: 5px; border-bottom: 1px solid #eee; }
        .irrf-input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }

        .highlight-box { border: 1px solid #e2e8f0; border-left: 4px solid var(--primary); background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .highlight-box.blue { border-left-color: var(--secondary); background: #fdfdff; }
        .highlight-box.orange { border-left-color: var(--warning); background: #fffcf5; }
        .highlight-title { font-weight: 700; margin-bottom: 10px; display: block; font-size: 0.9rem; color: #333; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Estilo para Licença Expirada */
        #license-lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 30px; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <!-- 1. TELA DE LOGIN -->
    <section id="auth-screen">
        <div style="text-align:center; max-width:400px; width:100%;">
            <i class="fa-solid fa-store" style="font-size:3.5rem; color:var(--primary); margin-bottom:10px;"></i>
            <h1>MEI Controle</h1>
            <p style="color:var(--text-muted); margin-bottom:20px;">Gestão de Comércio & Serviço</p>
            
            <form onsubmit="event.preventDefault(); app.handleAuth();">
                <div id="reg-fields" class="hidden">
                    <input type="text" id="auth-name" class="auth-input" placeholder="Seu Nome">
                    <input type="text" id="auth-empresa" class="auth-input" placeholder="Nome da Empresa (Obrigatório)">
                </div>
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-pass" class="auth-input" placeholder="Senha" required>
                
                <button class="btn btn-primary" id="btn-auth">Entrar</button>
            </form>
            
            <div style="margin-top:10px; cursor:pointer; color:var(--text-muted); font-size: 0.9rem;" onclick="app.forgotPassword()">
                Esqueci minha senha
            </div>

            <div style="margin-top:20px; cursor:pointer; color:var(--secondary);" onclick="app.toggleAuthMode()">
                <span id="link-toggle">Criar nova conta</span>
            </div>
            
            <div id="config-warning" class="hidden" style="margin-top:20px; padding:10px; background:#fee2e2; color:#991b1b; border-radius:8px; font-size:0.8rem;">
                ⚠ Configure as chaves do Firebase no código!
            </div>
        </div>
    </section>

    <!-- TELA DE BLOQUEIO DE LICENÇA -->
    <div id="license-lock-screen" class="hidden">
        <i class="fa-solid fa-lock" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
        <h2 style="color: var(--danger);">Acesso Expirado</h2>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Seu período de uso encerrou. Insira um código de renovação nas configurações.</p>
        <button class="btn btn-secondary" onclick="app.navTo('settings', document.querySelector('.bottom-nav button:nth-child(3)')); document.getElementById('license-lock-screen').classList.add('hidden');">
            Ir para Configurações
        </button>
    </div>

    <!-- 2. APP PRINCIPAL -->
    <section id="app-screen" class="hidden">
        <header>
            <div class="container flex justify-between">
                <div class="flex" style="gap: 15px;">
                    <button onclick="app.logout()" class="btn-outline btn-sm" style="border:none; color:var(--danger); font-size:1.1rem; padding: 0;" title="Sair do App">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                    <div>
                        <h2 style="font-size:1rem;" id="head-fantasy">Minha Empresa</h2>
                        <p style="font-size:0.75rem; color:var(--text-muted);" id="head-name">Usuário</p>
                    </div>
                </div>
                <button onclick="app.openTxModal()" class="btn-primary" style="width:auto; padding:8px 15px; font-size:0.8rem; border-radius:20px;">
                    <i class="fa-solid fa-plus"></i> Novo
                </button>
            </div>
        </header>

        <main class="container" style="padding-top:20px;">
            <div id="view-home">
                <div id="das-alert" class="alert-das hidden"></div>
                <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                    <p style="opacity:0.9;">Saldo Atual</p>
                    <h1 style="font-size:2.5rem;" id="dash-bal">R$ 0,00</h1>
                    <div class="flex justify-between" style="font-size:0.85rem; margin-top:10px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
                        <span><i class="fa-solid fa-arrow-up"></i> Receita: <span id="dash-inc">0,00</span></span>
                        <span><i class="fa-solid fa-arrow-down"></i> Despesa: <span id="dash-exp">0,00</span></span>
                    </div>
                </div>
                <div id="nf-shortcut" class="hidden" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="app.openNFLink()"><i class="fa-solid fa-file-invoice"></i> Emitir Nota Fiscal</button>
                </div>
                <div id="das-shortcut" class="hidden" style="margin-bottom: 15px;">
                    <button class="btn btn-warning" onclick="app.openDASLink()"><i class="fa-solid fa-barcode"></i> Pagar DAS (MEI)</button>
                </div>
                <div id="rpa-shortcut" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="app.openRPAModal()"><i class="fa-solid fa-file-contract"></i> Gerar Recibo RPA</button>
                </div>
                <h3>Histórico</h3>
                <div id="list-recent"></div>
                <div id="empty-state" class="hidden" style="text-align:center; padding:30px; color:var(--text-muted);">
                    <p>Sem dados neste dispositivo.</p>
                </div>
            </div>

            <div id="view-registers" class="hidden">
                <h2>Cadastros</h2>
                <div class="tab-menu">
                    <button class="tab-btn active" onclick="app.setRegTab('clients')">Clientes</button>
                    <button class="tab-btn" onclick="app.setRegTab('suppliers')">Fornecedores</button>
                    <button class="tab-btn" onclick="app.setRegTab('products')">Produtos</button>
                    <button class="tab-btn" onclick="app.setRegTab('services')">Serviços</button>
                </div>
                <div class="flex justify-between" style="margin-bottom: 15px;">
                    <h3 id="reg-title">Lista</h3>
                    <div class="flex" style="gap:5px;">
                        <button class="btn-dark btn-sm" onclick="app.downloadRegPDF()" title="Baixar PDF"><i class="fa-solid fa-file-pdf"></i></button>
                        <button id="btn-shopping-list" class="btn-warning btn-sm hidden" onclick="app.openShoppingList()"><i class="fa-solid fa-cart-shopping"></i> Lista Compras</button>
                        <button class="btn-primary btn-sm" onclick="app.openRegModal()"><i class="fa-solid fa-plus"></i> Adicionar</button>
                    </div>
                </div>
                <div id="reg-list"></div>
            </div>

            <div id="view-settings" class="hidden">
                <h2>Configurações</h2>
                
                <!-- PAINEL DE LICENÇA -->
                <div class="card" style="border-left: 4px solid var(--secondary);">
                    <h3><i class="fa-solid fa-key"></i> Licença de Uso</h3>
                    <p id="license-status" style="font-weight:bold; margin: 10px 0; color: var(--primary);">Verificando...</p>
                    
                    <button class="btn btn-secondary" onclick="app.generateCode()">Solicitar Créditos (Gerar Código)</button>
                    <p id="generated-code-display" style="text-align:center; font-size:1.5rem; font-weight:bold; letter-spacing:2px; margin:10px 0; color:var(--text-main); display:none;"></p>
                    
                    <div class="flex" style="gap:10px; margin-top:10px;">
                        <input type="text" id="license-input" class="auth-input" placeholder="Contra-senha (xxxxxx-yy)" style="margin:0;">
                        <button class="btn btn-primary" style="width:auto; margin:0;" onclick="app.activateLicense()">Ativar</button>
                    </div>

                    <!-- ADMIN PANEL -->
                    <div id="admin-panel" class="hidden" style="margin-top:15px; padding:10px; background:#fee2e2; border-radius:8px;">
                        <p style="color:#991b1b; font-weight:bold; margin-bottom:5px;">Admin (jcnvap)</p>
                        <button class="btn btn-danger btn-sm" onclick="app.adminZeroDays()">Zerar Dias</button>
                        <button class="btn btn-warning btn-sm" onclick="app.adminOneDay()">Setar 1 Dia</button>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-shop"></i> Modo Comerciante</h3>
                    <div class="flex justify-between" style="margin-top:10px;">
                        <span style="font-size:0.9rem; color:var(--text-muted);">Sou Comerciante (Vendo Produtos)</span>
                        <label class="switch">
                            <input type="checkbox" id="conf-merchant-mode" onchange="app.toggleMerchantMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fa-solid fa-table"></i> Tabela IRRF</h3>
                    <table class="irrf-table">
                        <thead><tr><th>Até R$ (Limite)</th><th>Alíq. %</th><th>Dedução R$</th></tr></thead>
                        <tbody id="irrf-config-body"></tbody>
                    </table>
                    <button class="btn btn-secondary btn-sm" style="margin-top:10px;" onclick="app.saveIRRFConfig()">Salvar Tabela</button>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-id-card"></i> Dados da Empresa</h3>
                    <button class="btn btn-outline" onclick="app.openProfileModal()"><i class="fa-solid fa-pen"></i> Editar Dados</button>
                    <button class="btn btn-outline" onclick="app.openPassModal()"><i class="fa-solid fa-lock"></i> Alterar Senha</button>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-folder-open"></i> Fiscal & Docs</h3>
                    <label class="form-label">Link Emissor Nacional (NF):</label>
                    <div class="flex" style="gap:5px;">
                        <input type="text" id="conf-nf-link" class="auth-input" style="margin:0;">
                        <button class="btn-secondary btn-sm" onclick="app.saveNFLink()">Salvar</button>
                    </div>
                    <label class="form-label">Link Pagamento DAS:</label>
                    <div class="flex" style="gap:5px;">
                        <input type="text" id="conf-das-link" class="auth-input" style="margin:0;">
                        <button class="btn-secondary btn-sm" onclick="app.saveDASLink()">Salvar</button>
                    </div>
                    <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                    <button class="btn btn-outline" onclick="app.downloadManual()"><i class="fa-solid fa-file-pdf"></i> Baixar Manual/PDF</button>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-cloud-arrow-down"></i> Segurança</h3>
                    <button class="btn btn-dark" onclick="app.backupData()"><i class="fa-solid fa-download"></i> Baixar Backup</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-upload"></i> Restaurar</button>
                    <input type="file" id="file-input" accept=".json" class="hidden" onchange="app.restoreData(this)">
                    <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                    <button class="btn btn-warning" onclick="app.generateMockData()"><i class="fa-solid fa-database"></i> Gerar Dados de Teste</button>
                </div>

                <div class="card">
                    <p id="conf-email" style="text-align:center; margin-bottom:10px; color:var(--text-muted);">...</p>
                    <button class="btn btn-danger" onclick="app.logout()">Sair</button>
                </div>

                <div class="app-footer">
                    <p>Desenvolvido por <a href="https://www.websitelog.com.br" target="_blank" class="website-link">Websitelog</a></p>
                    <div class="donation-box">
                        <p>Este app é gratuito. Apoie o desenvolvimento.</p>
                        <button class="btn btn-primary" onclick="app.navTo('support', document.querySelector('.nav-item:last-child'))" style="width:auto; margin:0 auto; font-size:0.9rem; padding:8px 20px;">
                            <i class="fa-brands fa-pix"></i> Apoiar Projeto
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-support" class="hidden" style="text-align: center; padding: 40px 20px;">
                <i class="fa-solid fa-hand-holding-heart" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
                <h2 style="margin-bottom: 15px;">Apoie o Projeto ☕</h2>
                <div class="pix-grid">
                    <button class="btn-pix" onclick="app.generatePixCopyPaste(5)">R$ 5,00</button>
                    <button class="btn-pix" onclick="app.generatePixCopyPaste(9)">R$ 9,00</button>
                    <button class="btn-pix" onclick="app.generatePixCopyPaste(12)">R$ 12,00</button>
                    <button class="btn-pix" onclick="app.copyPixKeyOnly()">Outro</button>
                </div>
                <div id="pix-feedback-msg" class="pix-feedback">✅ Código Pix Copiado com Sucesso!</div>
                <div id="pix-display-area" class="pix-display-area"></div>
                <p style="margin-top:30px; font-size:0.8rem; color:var(--text-muted);">Chave: b4648948-d0a8-4402-81f4-8a4047fcf4e5</p>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.navTo('home', this)"><i class="fa-solid fa-chart-pie"></i>Início</button>
            <button class="nav-item" onclick="app.navTo('registers', this)"><i class="fa-solid fa-address-book"></i>Cadastros</button>
            <button class="nav-item" onclick="app.navTo('settings', this)"><i class="fa-solid fa-user-gear"></i>Config</button>
            <button class="nav-item" onclick="app.navTo('support', this)"><i class="fa-solid fa-heart"></i>Apoio</button>
        </nav>
    </section>

    <!-- MODAL: NOVA TRANSAÇÃO -->
    <div id="modal-tx" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-tx')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Novo Lançamento</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-tx')"></i></div>
            <div class="type-switch"><div class="type-opt active inc" id="opt-inc" onclick="app.setType('income')">Entrada</div><div class="type-opt" id="opt-exp" onclick="app.setType('expense')">Saída</div></div>
            <div id="merchant-options" class="hidden">
                <div class="radio-group">
                    <label class="radio-item"><input type="radio" name="tx-action" value="sale" onclick="app.handleStockAction('sale')"><strong>Venda</strong> (Baixar)</label>
                    <label class="radio-item"><input type="radio" name="tx-action" value="buy" onclick="app.handleStockAction('buy')"><strong>Compra</strong> (Adicionar)</label>
                    <label class="radio-item"><input type="radio" name="tx-action" value="other" checked onclick="app.handleStockAction('other')"><strong>Outro</strong></label>
                </div>
                <div id="tx-prod-details" class="hidden" style="margin-top:10px; padding:10px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">
                    <label class="form-label">Produto</label>
                    <select id="tx-prod-select" class="auth-input" onchange="app.onTxProductChange()"></select>
                    <div class="flex" style="gap:10px;">
                        <div><label class="form-label">Qtd</label><input type="number" id="tx-prod-qty" class="auth-input" value="1" min="1" oninput="app.calcTxTotal()"></div>
                        <div><label class="form-label">Preço</label><input type="number" id="tx-prod-price" class="auth-input" oninput="app.calcTxTotal()" style="background:#fff;"></div>
                    </div>
                </div>
            </div>
            <label class="form-label">Valor Total (R$)</label>
            <input type="number" id="tx-val" class="auth-input" step="0.01" style="font-size:1.4rem; font-weight:bold;">
            <label class="form-label">Categoria</label>
            <select id="tx-cat" class="auth-input"></select>
            <label class="form-label">Data</label>
            <input type="date" id="tx-date" class="auth-input">
            <label class="form-label">Descrição</label>
            <input type="text" id="tx-desc" class="auth-input" placeholder="Detalhes">
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveTx()">Salvar</button>
        </div>
    </div>

    <!-- MODAL REGISTRO -->
    <div id="modal-reg" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-reg')">
        <div class="modal-content">
            <div class="flex justify-between"><h2 id="reg-modal-title">Novo Item</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-reg')"></i></div>
            <div class="highlight-box"><label class="form-label" id="reg-name-label">Nome</label><input type="text" id="reg-name" class="auth-input"><div id="reg-fields-extra"></div></div>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveRegister()">Salvar</button>
        </div>
    </div>

    <!-- MODAL RPA -->
    <div id="modal-rpa" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-rpa')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Gerar RPA</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-rpa')"></i></div>
            <div class="highlight-box">
                <span class="highlight-title" style="color:var(--primary-dark);">1. Contratante</span>
                <select id="rpa-client-select" class="auth-input" onchange="app.fillRPAClient()"><option value="">-- Selecionar --</option></select>
                <input type="text" id="rpa-cli-razao" class="auth-input" placeholder="Razão Social"><div class="flex" style="gap:5px;"><input type="text" id="rpa-cli-cnpj" class="auth-input" placeholder="CNPJ/CPF"><input type="text" id="rpa-cli-addr" class="auth-input" placeholder="Endereço"></div>
            </div>
            <div class="highlight-box blue">
                <span class="highlight-title" style="color:var(--secondary);">2. Prestador</span>
                <select id="rpa-supplier-select" class="auth-input" onchange="app.fillRPASupplier()"><option value="">-- Selecionar --</option></select>
                <input type="text" id="rpa-supp-name" class="auth-input" placeholder="Nome"><div class="flex" style="gap:5px;"><input type="text" id="rpa-supp-doc" class="auth-input" placeholder="CPF/CNPJ"><input type="tel" id="rpa-supp-phone" class="auth-input" placeholder="Tel"></div><input type="text" id="rpa-supp-addr" class="auth-input" placeholder="Endereço">
            </div>
            <div class="highlight-box orange">
                <span class="highlight-title" style="color:#b45309;">3. Serviço & Valores</span>
                <label class="form-label">Descrição</label><input type="text" id="rpa-desc" class="auth-input">
                <label class="form-label">Data</label><input type="date" id="rpa-date" class="auth-input">
                <div class="flex" style="gap:10px; align-items:flex-end;"><div style="flex:1;"><label class="form-label">Valor Bruto</label><input type="number" id="rpa-val" class="auth-input" step="0.01" oninput="app.calcRPA()"></div><div style="width:80px;"><label class="form-label">% ISS</label><input type="number" id="rpa-iss-pct" class="auth-input" value="0" oninput="app.calcRPA()"></div></div>
                <div class="rpa-results"><div class="rpa-line"><span>(-) INSS (11%)</span><span id="rpa-res-inss">R$ 0,00</span></div><div class="rpa-line"><span>(-) ISS</span><span id="rpa-res-iss">R$ 0,00</span></div><div class="rpa-line"><span>(-) IRRF</span><span id="rpa-res-irrf">R$ 0,00</span></div><div class="rpa-line" style="font-weight:bold; color:var(--primary-dark);"><span>Líquido</span><span id="rpa-res-liq">R$ 0,00</span></div></div>
            </div>
            <div class="flex" style="gap:10px; margin-top:15px;"><button class="btn btn-primary" style="flex:1;" onclick="app.downloadRPAWord()"><i class="fa-solid fa-file-word"></i> Word</button><button class="btn btn-danger" style="flex:1;" onclick="app.downloadRPAPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button></div>
        </div>
    </div>

    <div id="modal-stock" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-stock')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Movimentar Estoque</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-stock')"></i></div>
            <p id="stock-prod-name" style="text-align:center; font-weight:bold; margin-bottom:10px; color:var(--primary-dark);">Produto X</p>
            <div class="type-switch"><div class="type-opt active inc" id="stk-inc" onclick="app.setStockType('in')">Entrada</div><div class="type-opt" id="stk-exp" onclick="app.setStockType('out')">Saída</div></div>
            <label class="form-label">Qtd</label><input type="number" id="stk-qty" class="auth-input" style="font-size:1.5rem; text-align:center;" placeholder="0">
            <label class="form-label">Motivo</label><select id="stk-reason" class="auth-input"><option value="Compra">Compra / Reposição</option><option value="Devolução">Devolução</option></select>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveStockMovement()">Confirmar</button>
        </div>
    </div>

    <div id="modal-shopping" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-shopping')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Lista de Compras</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-shopping')"></i></div>
            <div id="shopping-list-content" style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:15px;"></div>
            <button class="btn btn-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i> Imprimir</button>
        </div>
    </div>

    <!-- MODAL PERFIL -->
    <div id="modal-profile" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-profile')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Editar Dados</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-profile')"></i></div>
            <label class="form-label">Nome Completo</label><input type="text" id="edit-name" class="auth-input">
            <label class="form-label">Nome da Empresa</label><input type="text" id="edit-fantasy" class="auth-input">
            <div class="flex" style="gap:10px;"><div style="flex:1"><label class="form-label">CPF/CNPJ</label><input type="tel" id="edit-doc" class="auth-input"></div><div style="flex:1"><label class="form-label">Telefone</label><input type="tel" id="edit-phone" class="auth-input"></div></div>
            <label class="form-label">Endereço</label><input type="text" id="edit-addr" class="auth-input">
            <label class="form-label">Atividade</label><input type="text" id="edit-activity" class="auth-input">
            <div class="flex" style="gap:10px;"><div style="flex:1"><label class="form-label">Isenção IRRF</label><input type="number" id="edit-irrf" class="auth-input" step="0.01"></div><div style="flex:1"><label class="form-label">% INSS</label><input type="number" id="edit-inss" class="auth-input" step="0.1"></div><div style="flex:1"><label class="form-label">% ISS</label><input type="number" id="edit-iss" class="auth-input" step="0.1"></div></div>
            <button class="btn btn-primary" onclick="app.saveProfile()">Atualizar</button>
        </div>
    </div>

    <!-- MODAL SENHA -->
    <div id="modal-pass" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-pass')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Alterar Senha</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-pass')"></i></div>
            <label class="form-label">Nova Senha</label><input type="password" id="new-pass" class="auth-input">
            <label class="form-label">Confirmar</label><input type="password" id="conf-pass" class="auth-input">
            <button class="btn btn-danger" onclick="app.changePassword()">Confirmar</button>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCijldF4haJzh0nzu4fbPYGHJadyYuqTP4",
            authDomain: "projmei.firebaseapp.com",
            projectId: "projmei",
            storageBucket: "projmei.firebasestorage.app",
            messagingSenderId: "39066795540",
            appId: "1:39066795540:web:edc72cedb442daee423101",
            measurementId: "G-PE631DFGE0"
        };

        const SEU_LINK_PDF = "https://drive.google.com/file/d/1gMocDMAey8q35-bcJsRip7Zm0v2mCrMS/view?usp=sharing"; 
        const DEFAULT_DAS_LINK = "https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao";
        const PIX_KEY = "b4648948-d0a8-4402-81f4-8a4047fcf4e5";

        // CONSTANTES DE SEGURANÇA
        const CONST_ADD = 13;
        const CONST_MULT = 9;
        const CONST_BASE = 1954;

        class App {
            constructor() {
                this.auth = null;
                this.db = null;
                this.user = null;
                this.licenseData = null;
                
                // Dados Locais
                this.txs = [];
                this.profile = {}; 
                this.settings = { nfLink: '', dasLink: '', merchantMode: false, irrfTable: [] }; 
                this.clients = [];
                this.suppliers = [];
                this.products = [];
                this.services = [];
                this.stockMovements = []; 

                this.isRegister = false;
                this.curType = 'income';
                this.curRegTab = 'clients'; 
                this.editIdx = null; 
                this.stockIdx = null; 
                this.stockType = 'in'; 
                this.txStockAction = 'other'; 
                this.activeRpaTxId = null;
                this.generatedCode = null;

                this.categories = {
                    income: ['Venda de Produto', 'Prestação de Serviço', 'Outras Receitas'],
                    expense: ['Compra de Mercadoria', 'Material de Uso', 'Aluguel', 'Água/Luz/Internet', 'Imposto (DAS)', 'Transporte', 'Retirada Pessoal', 'Outras Despesas']
                };

                this.initFirebase();
            }

            initFirebase() {
                if (typeof firebase === 'undefined') {
                    alert("Erro: Firebase SDK não carregado. Verifique sua conexão.");
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                this.auth = firebase.auth();
                this.db = firebase.firestore();

                this.auth.onAuthStateChanged((user) => {
                    if (user) {
                        this.user = user;
                        this.onLoginSuccess();
                    } else {
                        this.user = null;
                        this.showAuth();
                    }
                });
            }

            // --- AUTH & LICENÇA ---
            async handleAuth() {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                const name = document.getElementById('auth-name').value;
                const empresa = document.getElementById('auth-empresa').value; // Novo campo empresa

                try {
                    if (this.isRegister) {
                        if(!name) return alert("Digite seu nome.");
                        if(!empresa) return alert("Nome da Empresa é obrigatório.");

                        const cred = await this.auth.createUserWithEmailAndPassword(email, pass);
                        await cred.user.updateProfile({ displayName: name });
                        
                        // Inicializar perfil local com Nome da Empresa
                        const profile = { fantasy: empresa };
                        localStorage.setItem(`mei_profile_${cred.user.uid}`, JSON.stringify(profile));

                        // Inicializar Licença no Firestore (30 dias)
                        const expiryDate = new Date();
                        expiryDate.setDate(expiryDate.getDate() + 30);
                        await this.db.collection("licenses").doc(cred.user.uid).set({
                            validUntil: expiryDate.getTime()
                        });

                    } else {
                        await this.auth.signInWithEmailAndPassword(email, pass);
                    }
                } catch (e) { alert("Erro: " + e.message); }
            }

            async forgotPassword() {
                const email = prompt("Digite seu e-mail para recuperação:");
                if(email) {
                    try {
                        await this.auth.sendPasswordResetEmail(email);
                        alert("E-mail de recuperação enviado! Verifique sua caixa de entrada.");
                    } catch(e) { alert("Erro: " + e.message); }
                }
            }

            toggleAuthMode() {
                this.isRegister = !this.isRegister;
                document.getElementById('reg-fields').classList.toggle('hidden');
                document.getElementById('btn-auth').innerText = this.isRegister ? "Cadastrar" : "Entrar";
                document.getElementById('link-toggle').innerText = this.isRegister ? "Já tenho conta" : "Criar nova conta";
            }

            logout() { this.auth.signOut(); location.reload(); }
            showAuth() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('license-lock-screen').classList.add('hidden');
            }

            // --- CARREGAMENTO DE DADOS ---
            async onLoginSuccess() {
                const uid = this.user.uid;
                
                // 1. Verificar Licença no Firestore
                try {
                    const licenseRef = this.db.collection("licenses").doc(uid);
                    const licenseSnap = await licenseRef.get();
                    if (licenseSnap.exists) {
                        this.licenseData = licenseSnap.data();
                        this.checkLicenseValidity();
                    } else {
                        // Fallback: 30 dias se não houver licença
                        this.licenseData = { validUntil: Date.now() + (30*24*60*60*1000) };
                        await licenseRef.set(this.licenseData);
                    }
                } catch(e) { console.error("Erro licença", e); }

                // 2. Carregar App
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('conf-email').innerText = this.user.email;

                // Admin Panel check
                if(this.user.email === 'jcnvap@gmail.com') {
                    document.getElementById('admin-panel').classList.remove('hidden');
                }

                // Configurações e Dados Locais
                const defaultIRRF = [
                    { limit: 2428.80, rate: 0, ded: 0 },
                    { limit: 2826.65, rate: 7.5, ded: 182.16 },
                    { limit: 3751.05, rate: 15.0, ded: 394.16 },
                    { limit: 4664.68, rate: 22.5, ded: 675.49 },
                    { limit: 99999999, rate: 27.5, ded: 908.73 }
                ];

                const defaultSettings = JSON.stringify({ 
                    nfLink: "https://www.nfse.gov.br/EmissorNacional", 
                    dasLink: DEFAULT_DAS_LINK,
                    merchantMode: false,
                    irrfTable: defaultIRRF
                });
                
                this.settings = JSON.parse(localStorage.getItem(`mei_settings_${uid}`) || defaultSettings);
                if(!this.settings.dasLink) this.settings.dasLink = DEFAULT_DAS_LINK;
                if(!this.settings.irrfTable || this.settings.irrfTable.length === 0) this.settings.irrfTable = defaultIRRF;

                this.txs = JSON.parse(localStorage.getItem(`mei_data_${uid}`) || '[]');
                this.profile = JSON.parse(localStorage.getItem(`mei_profile_${uid}`) || '{"fantasy":"","doc":""}');
                this.clients = JSON.parse(localStorage.getItem(`mei_clients_${uid}`) || '[]');
                this.suppliers = JSON.parse(localStorage.getItem(`mei_suppliers_${uid}`) || '[]');
                this.products = JSON.parse(localStorage.getItem(`mei_products_${uid}`) || '[]');
                this.services = JSON.parse(localStorage.getItem(`mei_services_${uid}`) || '[]');
                this.stockMovements = JSON.parse(localStorage.getItem(`mei_stock_${uid}`) || '[]');

                document.getElementById('conf-merchant-mode').checked = this.settings.merchantMode || false;

                this.render();
                this.renderHeader();
                this.renderIRRFConfig();
                this.checkNFLink();
                this.checkDASLink();
                this.checkDASAlert();
            }

            checkLicenseValidity() {
                const now = Date.now();
                const validUntil = this.licenseData.validUntil;
                const daysLeft = Math.ceil((validUntil - now) / (1000 * 60 * 60 * 24));
                
                const statusEl = document.getElementById('license-status');
                
                if (daysLeft <= 0) {
                    document.getElementById('license-lock-screen').classList.remove('hidden');
                    statusEl.innerText = "EXPIRADA";
                    statusEl.style.color = "var(--danger)";
                } else {
                    document.getElementById('license-lock-screen').classList.add('hidden');
                    statusEl.innerText = `Ativa: ${daysLeft} dias restantes`;
                    statusEl.style.color = "var(--primary)";
                }
            }

            // --- SISTEMA DE CÓDIGOS DE LICENÇA ---
            generateCode() {
                const code = Math.floor(Math.random() * (1000 - 100 + 1)) + 100;
                this.generatedCode = code;
                const display = document.getElementById('generated-code-display');
                display.innerText = code;
                display.style.display = 'block';
            }

            async activateLicense() {
                const input = document.getElementById('license-input').value;
                if (!input.includes('-')) return alert("Formato inválido. Use: senha-dias");
                if (!this.generatedCode) return alert("Gere um código primeiro.");

                const [pass, days] = input.split('-');
                const passInt = parseInt(pass);
                const daysInt = parseInt(days);

                // Cálculo Seguro
                const expectedPass = (this.generatedCode + CONST_ADD) * CONST_MULT + CONST_BASE;

                if (passInt === expectedPass) {
                    try {
                        const newExpiry = Date.now() + (daysInt * 24 * 60 * 60 * 1000);
                        await this.db.collection("licenses").doc(this.user.uid).update({
                            validUntil: newExpiry
                        });
                        this.licenseData.validUntil = newExpiry;
                        this.checkLicenseValidity();
                        alert(`Sucesso! Adicionados ${daysInt} dias.`);
                        document.getElementById('license-input').value = '';
                        document.getElementById('generated-code-display').style.display = 'none';
                        this.generatedCode = null;
                    } catch(e) { alert("Erro ao salvar licença: " + e.message); }
                } else {
                    alert("Contra-senha inválida!");
                }
            }

            // --- ADMIN FUNCTIONS ---
            async adminZeroDays() {
                if(this.user.email !== 'jcnvap@gmail.com') return;
                if(!confirm("Zerar licença?")) return;
                await this.db.collection("licenses").doc(this.user.uid).update({ validUntil: Date.now() - 1000 });
                location.reload();
            }
            async adminOneDay() {
                if(this.user.email !== 'jcnvap@gmail.com') return;
                const oneDay = Date.now() + (24 * 60 * 60 * 1000);
                await this.db.collection("licenses").doc(this.user.uid).update({ validUntil: oneDay });
                location.reload();
            }

            renderHeader() {
                document.getElementById('head-name').innerText = this.user.displayName || "Usuário";
                document.getElementById('head-fantasy').innerText = this.profile.fantasy || "Minha Empresa";
                document.getElementById('conf-nf-link').value = this.settings.nfLink || '';
                document.getElementById('conf-das-link').value = this.settings.dasLink || '';
            }
            
            renderIRRFConfig() {
                const tbody = document.getElementById('irrf-config-body');
                tbody.innerHTML = '';
                this.settings.irrfTable.forEach((row, idx) => {
                    const isLast = idx === this.settings.irrfTable.length - 1;
                    const limitVal = isLast ? "" : row.limit;
                    const disabled = isLast ? "disabled style='background:#eee;'" : "";
                    
                    tbody.innerHTML += `<tr><td>${isLast ? 'Acima' : ''}<input type="number" step="0.01" class="irrf-input" value="${limitVal}" onchange="app.updateIRRFVal(${idx}, 'limit', this.value)" ${disabled}></td><td><input type="number" step="0.1" class="irrf-input" value="${row.rate}" onchange="app.updateIRRFVal(${idx}, 'rate', this.value)"></td><td><input type="number" step="0.01" class="irrf-input" value="${row.ded}" onchange="app.updateIRRFVal(${idx}, 'ded', this.value)"></td></tr>`;
                });
            }

            updateIRRFVal(idx, key, val) {
                if(key === 'limit' && val === "") return;
                this.settings.irrfTable[idx][key] = parseFloat(val);
            }

            saveIRRFConfig() {
                this.settings.irrfTable[this.settings.irrfTable.length-1].limit = 999999999;
                localStorage.setItem(`mei_settings_${this.user.uid}`, JSON.stringify(this.settings));
                alert("Tabela IRRF salva com sucesso!");
            }

            checkDASAlert() {
                const today = new Date().getDate();
                const el = document.getElementById('das-alert');
                if (today >= 15 && today <= 19) {
                    el.className = 'alert-das das-warning'; el.innerText = '📅 Lembrete MEI: O DAS vence dia 20!'; el.classList.remove('hidden');
                } else if (today === 20) {
                    el.className = 'alert-das das-urgent'; el.innerText = '🚨 Seu DAS vence hoje!'; el.classList.remove('hidden');
                } else { el.classList.add('hidden'); }
            }

            toggleMerchantMode() {
                this.settings.merchantMode = document.getElementById('conf-merchant-mode').checked;
                localStorage.setItem(`mei_settings_${this.user.uid}`, JSON.stringify(this.settings));
                alert(this.settings.merchantMode ? "Modo Comerciante Ativado!" : "Modo Simples Ativado.");
            }

            setRegTab(tab) {
                this.curRegTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                const titles = { clients: 'Clientes', suppliers: 'Fornecedores', products: 'Produtos', services: 'Serviços' };
                document.getElementById('reg-title').innerText = titles[tab];
                const tabs = ['clients', 'suppliers', 'products', 'services'];
                document.querySelectorAll('.tab-btn')[tabs.indexOf(tab)].classList.add('active');
                if(tab === 'products') document.getElementById('btn-shopping-list').classList.remove('hidden');
                else document.getElementById('btn-shopping-list').classList.add('hidden');
                this.renderRegList();
            }

            renderRegList() {
                const list = document.getElementById('reg-list');
                list.innerHTML = '';
                let data = [];
                if(this.curRegTab === 'clients') data = this.clients;
                if(this.curRegTab === 'suppliers') data = this.suppliers;
                if(this.curRegTab === 'products') data = this.products;
                if(this.curRegTab === 'services') data = this.services;

                if(data.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px;">Nenhum item cadastrado.</p>'; return;
                }

                data.forEach((item, idx) => {
                    let subInfo = '';
                    let stockBadge = '';
                    if(this.curRegTab === 'products') {
                        subInfo = `R$ ${parseFloat(item.price).toFixed(2)}`;
                        if(item.supplier) subInfo += ` | F: ${item.supplier}`;
                        const curr = parseInt(item.currentStock || 0);
                        const min = parseInt(item.minStock || 0);
                        let colorClass = 'stock-ok';
                        if(curr <= min) colorClass = 'stock-crit'; else if(curr <= min * 1.5) colorClass = 'stock-low';
                        stockBadge = `<span class="badge-stock ${colorClass}">Est: ${curr}</span>`;
                    } else if(this.curRegTab === 'services') subInfo = `R$ ${parseFloat(item.price).toFixed(2)}`;
                    else { subInfo = item.phone || ''; if(item.doc) subInfo += (subInfo ? ' | ' : '') + item.doc; }

                    list.innerHTML += `<div class="tx-item"><div><strong>${item.name}</strong> ${stockBadge}<br><small style="color:var(--text-muted)">${subInfo}</small>${(this.curRegTab === 'clients' && item.corpName) ? `<br><small style="color:var(--text-muted); font-size:0.75rem;">${item.corpName}</small>` : ''}${(this.curRegTab === 'suppliers' && item.address) ? `<br><small style="color:var(--text-muted); font-size:0.75rem;"><i class="fa-solid fa-location-dot"></i> ${item.address}</small>` : ''}</div><div style="display:flex; gap:8px;">${this.curRegTab === 'products' ? `<button class="btn-outline btn-sm" onclick="app.openStockModal(${idx})" title="Movimentar Estoque"><i class="fa-solid fa-box"></i></button>` : ''}<button class="btn-outline btn-sm" onclick="app.openRegModal(${idx})" style="color:var(--primary);"><i class="fa-solid fa-pen"></i></button><button class="btn-outline btn-sm" onclick="app.deleteRegister(${idx})" style="color:var(--danger);"><i class="fa-solid fa-trash"></i></button></div></div>`;
                });
            }

            async downloadRegPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let title = '', head = [], body = [];
                
                if (this.curRegTab === 'clients') {
                    title = 'Lista de Clientes'; head = [['Nome', 'Razão Social', 'Doc', 'Tel', 'Endereço']]; body = this.clients.map(i => [i.name, i.corpName || '-', i.doc || '-', i.phone || '-', i.address || '-']);
                } else if (this.curRegTab === 'suppliers') {
                    title = 'Lista de Fornecedores'; head = [['Nome', 'Telefone', 'Documento', 'Endereço']]; body = this.suppliers.map(i => [i.name, i.phone, i.doc, i.address || '-']);
                } else if (this.curRegTab === 'products') {
                    title = 'Lista de Produtos'; head = [['Produto', 'Preço (R$)', 'Custo (R$)', 'Estoque', 'Fornecedor']]; body = this.products.map(i => [i.name, parseFloat(i.price).toFixed(2), parseFloat(i.cost).toFixed(2), i.currentStock, i.supplier]);
                } else if (this.curRegTab === 'services') {
                    title = 'Lista de Serviços'; head = [['Serviço', 'Preço (R$)', 'Custo (R$)']]; body = this.services.map(i => [i.name, parseFloat(i.price).toFixed(2), parseFloat(i.cost).toFixed(2)]);
                }

                doc.text(title, 14, 10);
                doc.autoTable({ head: head, body: body, startY: 20 });
                
                const filename = `${this.curRegTab}_${new Date().toISOString().slice(0,10)}.pdf`;
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            }

            openRegModal(idx = null) {
                this.editIdx = idx; document.getElementById('reg-name').value = '';
                const extra = document.getElementById('reg-fields-extra'); extra.innerHTML = '';
                const nameLabel = document.getElementById('reg-name-label');
                let data = null;
                if (idx !== null) {
                    if(this.curRegTab === 'clients') data = this.clients[idx]; else if(this.curRegTab === 'suppliers') data = this.suppliers[idx];
                    else if(this.curRegTab === 'products') data = this.products[idx]; else data = this.services[idx];
                    document.getElementById('reg-name').value = data.name;
                }

                if(this.curRegTab === 'products') {
                    document.getElementById('reg-modal-title').innerText = idx !== null ? "Editar Produto" : "Novo Produto";
                    nameLabel.innerText = "Nome do Produto";
                    let supOptions = '<option value="">Sem Fornecedor</option>';
                    this.suppliers.forEach(s => { supOptions += `<option value="${s.name}">${s.name}</option>`; });
                    extra.innerHTML = `<div class="flex" style="gap:10px;"><div><label class="form-label">Preço Venda</label><input type="number" id="reg-price" class="auth-input" step="0.01"></div><div><label class="form-label">Custo</label><input type="number" id="reg-cost" class="auth-input" step="0.01"></div></div><div class="flex" style="gap:10px;"><div><label class="form-label">Est. Atual</label><input type="number" id="reg-curr-stk" class="auth-input"></div><div><label class="form-label">Est. Mínimo</label><input type="number" id="reg-min-stk" class="auth-input"></div><div><label class="form-label">Est. Ideal</label><input type="number" id="reg-ideal-stk" class="auth-input"></div></div><label class="form-label">Fornecedor</label><select id="reg-supplier" class="auth-input">${supOptions}</select>`;
                    if(idx !== null) { setTimeout(() => { document.getElementById('reg-price').value = data.price; document.getElementById('reg-cost').value = data.cost; document.getElementById('reg-supplier').value = data.supplier || ''; document.getElementById('reg-curr-stk').value = data.currentStock || 0; document.getElementById('reg-min-stk').value = data.minStock || 0; document.getElementById('reg-ideal-stk').value = data.idealStock || 0; }, 50); }
                } else if(this.curRegTab === 'services') {
                    document.getElementById('reg-modal-title').innerText = idx !== null ? "Editar Serviço" : "Novo Serviço";
                    nameLabel.innerText = "Nome do Serviço";
                    extra.innerHTML = `<label class="form-label">Preço de Venda (R$)</label><input type="number" id="reg-price" class="auth-input" step="0.01"><label class="form-label">Custo (Opcional)</label><input type="number" id="reg-cost" class="auth-input" step="0.01">`;
                    if(idx !== null) { setTimeout(() => { document.getElementById('reg-price').value = data.price; document.getElementById('reg-cost').value = data.cost; }, 50); }
                } else if(this.curRegTab === 'clients') {
                    document.getElementById('reg-modal-title').innerText = idx !== null ? "Editar Cliente" : "Novo Cliente";
                    nameLabel.innerText = "Nome do Cliente";
                    extra.innerHTML = `<label class="form-label">Razão Social (Opcional)</label><input type="text" id="reg-corp-name" class="auth-input"><div class="flex" style="gap:10px;"><div style="flex:1"><label class="form-label">CPF / CNPJ</label><input type="text" id="reg-doc" class="auth-input"></div><div style="flex:1"><label class="form-label">Telefone</label><input type="tel" id="reg-phone" class="auth-input"></div></div><label class="form-label">Endereço</label><input type="text" id="reg-addr" class="auth-input">`;
                    if(idx !== null) { setTimeout(() => { document.getElementById('reg-corp-name').value = data.corpName || ''; document.getElementById('reg-doc').value = data.doc || ''; document.getElementById('reg-phone').value = data.phone || ''; document.getElementById('reg-addr').value = data.address || ''; }, 50); }
                } else {
                    document.getElementById('reg-modal-title').innerText = "Novo Fornecedor";
                    nameLabel.innerText = "Nome do Fornecedor";
                    extra.innerHTML = `<label class="form-label">Telefone / WhatsApp</label><input type="tel" id="reg-phone" class="auth-input"><label class="form-label">CPF / CNPJ</label><input type="text" id="reg-doc" class="auth-input"><label class="form-label">Endereço</label><input type="text" id="reg-addr" class="auth-input">`;
                    if(idx !== null) { setTimeout(() => { document.getElementById('reg-phone').value = data.phone; document.getElementById('reg-doc').value = data.doc; document.getElementById('reg-addr').value = data.address || ''; }, 50); }
                }
                document.getElementById('modal-reg').classList.remove('hidden');
            }

            saveRegister() {
                const name = document.getElementById('reg-name').value;
                if(!name) return alert("Nome é obrigatório.");
                let newItem = { name };
                if(this.curRegTab === 'products') {
                    newItem.price = document.getElementById('reg-price').value || 0; newItem.cost = document.getElementById('reg-cost').value || 0; newItem.supplier = document.getElementById('reg-supplier').value || ''; newItem.currentStock = parseInt(document.getElementById('reg-curr-stk').value || 0); newItem.minStock = parseInt(document.getElementById('reg-min-stk').value || 0); newItem.idealStock = parseInt(document.getElementById('reg-ideal-stk').value || 0);
                    if (this.editIdx !== null) this.products[this.editIdx] = newItem; else this.products.push(newItem);
                    localStorage.setItem(`mei_products_${this.user.uid}`, JSON.stringify(this.products));
                } else if (this.curRegTab === 'services') {
                    newItem.price = document.getElementById('reg-price').value || 0; newItem.cost = document.getElementById('reg-cost').value || 0;
                    if (this.editIdx !== null) this.services[this.editIdx] = newItem; else this.services.push(newItem);
                    localStorage.setItem(`mei_services_${this.user.uid}`, JSON.stringify(this.services));
                } else if (this.curRegTab === 'clients') {
                    newItem.corpName = document.getElementById('reg-corp-name').value || ''; newItem.phone = document.getElementById('reg-phone').value || ''; newItem.doc = document.getElementById('reg-doc').value || ''; newItem.address = document.getElementById('reg-addr').value || '';
                    if (this.editIdx !== null) this.clients[this.editIdx] = newItem; else this.clients.push(newItem);
                    localStorage.setItem(`mei_clients_${this.user.uid}`, JSON.stringify(this.clients));
                } else {
                    newItem.phone = document.getElementById('reg-phone').value || ''; newItem.doc = document.getElementById('reg-doc').value || ''; newItem.address = document.getElementById('reg-addr').value || '';
                    if (this.editIdx !== null) this.suppliers[this.editIdx] = newItem; else this.suppliers.push(newItem);
                    localStorage.setItem(`mei_suppliers_${this.user.uid}`, JSON.stringify(this.suppliers));
                }
                this.closeModal('modal-reg'); this.renderRegList();
            }

            deleteRegister(idx) {
                if(!confirm("Excluir item?")) return;
                const arr = this.curRegTab === 'clients' ? this.clients : (this.curRegTab === 'suppliers' ? this.suppliers : (this.curRegTab === 'products' ? this.products : this.services));
                arr.splice(idx, 1); localStorage.setItem(`mei_${this.curRegTab}_${this.user.uid}`, JSON.stringify(arr)); this.renderRegList();
            }

            openStockModal(idx) {
                this.stockIdx = idx; const p = this.products[idx];
                document.getElementById('stock-prod-name').innerText = p.name; document.getElementById('stk-qty').value = ''; this.setStockType('in');
                document.getElementById('modal-stock').classList.remove('hidden');
            }

            setStockType(type) {
                this.stockType = type;
                const inc = document.getElementById('stk-inc'); const exp = document.getElementById('stk-exp'); const reason = document.getElementById('stk-reason');
                if(type === 'in') { inc.classList.add('active'); exp.classList.remove('active'); reason.innerHTML = '<option value="Compra">Compra</option><option value="Devolução">Devolução Cliente</option>'; }
                else { exp.classList.add('active'); inc.classList.remove('active'); reason.innerHTML = '<option value="Venda">Venda</option><option value="Perda">Perda / Quebra</option><option value="Uso">Uso Interno</option>'; }
            }

            saveStockMovement() {
                const qty = parseInt(document.getElementById('stk-qty').value);
                const reason = document.getElementById('stk-reason').value;
                if(!qty || qty <= 0) return alert("Quantidade inválida.");
                const p = this.products[this.stockIdx];
                const oldStock = parseInt(p.currentStock || 0);
                if(this.stockType === 'in') p.currentStock = oldStock + qty; else p.currentStock = Math.max(0, oldStock - qty);
                this.stockMovements.push({ date: new Date().toISOString(), product: p.name, type: this.stockType, qty: qty, reason: reason, newStock: p.currentStock });
                localStorage.setItem(`mei_products_${this.user.uid}`, JSON.stringify(this.products));
                localStorage.setItem(`mei_stock_${this.user.uid}`, JSON.stringify(this.stockMovements));
                alert("Estoque atualizado!"); this.closeModal('modal-stock'); this.renderRegList();
            }

            openShoppingList() {
                const listDiv = document.getElementById('shopping-list-content'); listDiv.innerHTML = '';
                let toBuy = this.products.filter(p => (parseInt(p.currentStock||0) <= parseInt(p.minStock||0)));
                if(toBuy.length === 0) listDiv.innerHTML = '<p>Tudo certo! Nenhum produto abaixo do mínimo.</p>';
                else {
                    let html = '<table style="width:100%; font-size:0.85rem; border-collapse:collapse;"><tr style="text-align:left; border-bottom:1px solid #ddd;"><th>Produto</th><th>Atual</th><th>Comprar</th></tr>';
                    toBuy.forEach(p => {
                        const ideal = parseInt(p.idealStock || 0); const curr = parseInt(p.currentStock || 0); const buyQty = ideal > curr ? (ideal - curr) : 0;
                        html += `<tr><td style="padding:5px;">${p.name}<br><small style="color:var(--text-muted)">${p.supplier||''}</small></td><td style="padding:5px; color:red;">${curr}</td><td style="padding:5px; font-weight:bold;">${buyQty > 0 ? buyQty : '-'}</td></tr>`;
                    });
                    html += '</table>'; listDiv.innerHTML = html;
                }
                document.getElementById('modal-shopping').classList.remove('hidden');
            }

            // PIX
            crc16(str) {
                let crc = 0xFFFF;
                for (let i = 0; i < str.length; i++) { crc ^= str.charCodeAt(i) << 8; for (let j = 0; j < 8; j++) { if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021; else crc = crc << 1; } }
                return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            }
            generatePixPayload(amount) {
                const format = (id, val) => id + val.length.toString().padStart(2, '0') + val;
                const merchantInfo = format('00', 'BR.GOV.BCB.PIX') + format('01', PIX_KEY);
                let payload = format('00', '01') + format('26', merchantInfo) + format('52', '0000') + format('53', '986');
                if (amount > 0) payload += format('54', amount.toFixed(2));
                payload += format('58', 'BR') + format('59', 'MEI CONTROLE') + format('60', 'BRASIL') + format('62', format('05', '***'));
                payload += '6304'; payload += this.crc16(payload); return payload;
            }
            generatePixCopyPaste(amount) {
                const code = this.generatePixPayload(amount);
                this.copyToClipboard(code, `Pix Copia e Cola de R$ ${amount},00 gerado!`);
                const disp = document.getElementById('pix-display-area'); disp.style.display = 'block'; disp.innerText = code;
            }
            copyPixKeyOnly() {
                this.copyToClipboard(PIX_KEY, "Chave Pix copiada!");
                const disp = document.getElementById('pix-display-area'); disp.style.display = 'block'; disp.innerText = PIX_KEY;
            }
            copyToClipboard(text, msg) {
                navigator.clipboard.writeText(text).then(() => {
                    const fb = document.getElementById('pix-feedback-msg'); fb.innerText = "✅ " + msg; fb.style.display = 'block'; setTimeout(() => fb.style.display = 'none', 5000);
                }).catch(err => alert("Erro ao copiar: " + text));
            }
            
            backupData() {
                const payload = { txs: this.txs, profile: this.profile, settings: this.settings, clients: this.clients, suppliers: this.suppliers, products: this.products, services: this.services, stockMovements: this.stockMovements };
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
                a.download = `backup_mei_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            }

            restoreData(input) {
                const file = input.files[0]; if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.txs) this.txs = json.txs; if(json.profile) this.profile = json.profile;
                        if(json.settings) this.settings = json.settings; if(json.clients) this.clients = json.clients;
                        if(json.suppliers) this.suppliers = json.suppliers; if(json.products) this.products = json.products;
                        if(json.services) this.services = json.services; if(json.stockMovements) this.stockMovements = json.stockMovements;
                        const uid = this.user.uid;
                        localStorage.setItem(`mei_data_${uid}`, JSON.stringify(this.txs)); localStorage.setItem(`mei_profile_${uid}`, JSON.stringify(this.profile)); localStorage.setItem(`mei_settings_${uid}`, JSON.stringify(this.settings)); localStorage.setItem(`mei_clients_${uid}`, JSON.stringify(this.clients)); localStorage.setItem(`mei_suppliers_${uid}`, JSON.stringify(this.suppliers)); localStorage.setItem(`mei_products_${uid}`, JSON.stringify(this.products)); localStorage.setItem(`mei_services_${uid}`, JSON.stringify(this.services)); localStorage.setItem(`mei_stock_${uid}`, JSON.stringify(this.stockMovements));
                        this.render(); this.renderHeader(); this.checkNFLink(); this.checkDASLink();
                        alert("Restaurado!");
                    } catch(e) { alert("Arquivo inválido"); }
                };
                reader.readAsText(file);
            }
            
            generateMockData() {
                if(!confirm("Gerar dados teste?")) return;
                const uid = this.user.uid;
                this.clients.push({ name: "Cliente Exemplo Ltda", corpName: "Exemplo Comércio", doc: "12.345.678/0001-90", phone: "(11) 98888-7777", address: "Rua das Flores, 123" });
                this.suppliers.push({ name: "Atacadão do Bairro", phone: "(11) 3333-4444", doc: "98.765.432/0001-10", address: "Av. Industrial, 500" });
                this.products.push({ name: "Produto Teste A", price: 50.00, cost: 25.00, supplier: "Atacadão do Bairro", currentStock: 5, minStock: 10, idealStock: 20 });
                this.services.push({ name: "Manutenção Padrão", price: 150.00, cost: 10.00 });
                localStorage.setItem(`mei_clients_${uid}`, JSON.stringify(this.clients));
                localStorage.setItem(`mei_suppliers_${uid}`, JSON.stringify(this.suppliers));
                localStorage.setItem(`mei_products_${uid}`, JSON.stringify(this.products));
                localStorage.setItem(`mei_services_${uid}`, JSON.stringify(this.services));
                alert("Dados de teste gerados!");
                this.renderRegList();
            }
        }
        
        // Inicialização Segura
        window.addEventListener('load', () => {
            try {
                window.app = new App();
            } catch(e) {
                console.error("Erro ao iniciar APP:", e);
                alert("Erro crítico ao iniciar aplicação. Verifique o console.");
            }
        });
    </script>
</body>
</html>