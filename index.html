<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEI Controle Total</title>
    
    <!-- Bibliotecas -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00bf63;
            --primary-dark: #00914b;
            --secondary: #5e17eb;
            --bg-light: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--text-main); height: 100vh; overflow-x: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-dark { background: var(--text-main); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 6px 10px; font-size: 0.85rem; width: auto; margin: 0; }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 15px; }

        /* Login */
        #auth-screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: var(--surface); position: fixed; top: 0; width: 100%; z-index: 9999; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-light); font-size: 1rem; }

        /* App */
        #app-screen { padding-bottom: 90px; }
        header { background: var(--surface); padding: 15px 0; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .text-green { color: var(--primary); }
        .text-red { color: var(--danger); }
        .text-warn { color: var(--warning); }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); padding: 10px 0; display: flex; justify-content: space-around; z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; background: none; border: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 600; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px; display: block; margin-top: 10px; }
        
        .type-switch { display: flex; background: var(--bg-light); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .type-opt { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .type-opt.active.inc { background: var(--primary); color: white; }
        .type-opt.active.exp { background: var(--danger); color: white; }
        
        /* Tabs para Cadastros */
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { background: var(--bg-light); border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 0.9rem; }
        .tab-btn.active { background: var(--text-main); color: white; border-color: var(--text-main); }

        /* Footer Styles */
        .app-footer { text-align: center; margin-top: 30px; margin-bottom: 20px; font-size: 0.8rem; color: var(--text-muted); padding: 10px; border-top: 1px solid var(--border); }
        .contact-links { display: flex; justify-content: center; gap: 20px; margin: 15px 0; font-size: 1.2rem; }
        .contact-links a { color: var(--text-main); transition: 0.2s; }
        .contact-links a:hover { color: var(--primary); }
        .website-link { color: var(--primary); text-decoration: none; font-weight: 600; }
        
        /* Nova Caixa de Doa√ß√£o */
        .donation-box { background: #f0fdf4; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 0.8rem; border: 1px dashed var(--primary); }
        .donation-box p { margin-bottom: 10px; line-height: 1.4; color: var(--text-main); }

        /* Badge Estoque */
        .badge-stock { background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .stock-ok { color: var(--primary-dark); background: #dcfce7; }
        .stock-low { color: #b45309; background: #fef3c7; }
        .stock-crit { color: #991b1b; background: #fee2e2; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Radio Group Custom */
        .radio-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; background: #fff; padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .radio-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; cursor: pointer; }
        .radio-item input { width: 18px; height: 18px; accent-color: var(--primary); }

        /* Estilo do Alerta DAS */
        .alert-das {
            padding: 12px; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            font-size: 0.9rem; 
            text-align: center;
            font-weight: 600;
        }
        .das-warning {
            background: #fff3cd; 
            color: #856404; 
            border: 1px solid #ffeeba; 
        }
        .das-urgent {
            background: #fee2e2; 
            color: #991b1b; 
            border: 1px solid #fecaca;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <!-- 1. TELA DE LOGIN -->
    <section id="auth-screen">
        <div style="text-align:center; max-width:400px; width:100%;">
            <i class="fa-solid fa-store" style="font-size:3.5rem; color:var(--primary); margin-bottom:10px;"></i>
            <h1>MEI Controle</h1>
            <p style="color:var(--text-muted); margin-bottom:20px;">Gest√£o de Com√©rcio & Servi√ßo</p>
            
            <form onsubmit="event.preventDefault(); app.handleAuth();">
                <div id="reg-fields" class="hidden">
                    <input type="text" id="auth-name" class="auth-input" placeholder="Seu Nome">
                </div>
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-pass" class="auth-input" placeholder="Senha" required>
                
                <button class="btn btn-primary" id="btn-auth">Entrar</button>
            </form>
            
            <div style="margin-top:20px; cursor:pointer; color:var(--secondary);" onclick="app.toggleAuthMode()">
                <span id="link-toggle">Criar nova conta</span>
            </div>
            
            <div id="config-warning" class="hidden" style="margin-top:20px; padding:10px; background:#fee2e2; color:#991b1b; border-radius:8px; font-size:0.8rem;">
                ‚ö† Configure as chaves do Firebase no c√≥digo!
            </div>
        </div>
    </section>

    <!-- 2. APP PRINCIPAL -->
    <section id="app-screen" class="hidden">
        <header>
            <div class="container flex justify-between">
                <div>
                    <h2 style="font-size:1rem;" id="head-fantasy">Minha Empresa</h2>
                    <p style="font-size:0.75rem; color:var(--text-muted);" id="head-name">Usu√°rio</p>
                </div>
                <button onclick="app.openTxModal()" class="btn-primary" style="width:auto; padding:8px 15px; font-size:0.8rem; border-radius:20px;">
                    <i class="fa-solid fa-plus"></i> Novo
                </button>
            </div>
        </header>

        <main class="container" style="padding-top:20px;">
            <!-- VIEW: DASHBOARD -->
            <div id="view-home">
                
                <!-- ALERTA DAS (VISIVEL DINAMICAMENTE) -->
                <div id="das-alert" class="alert-das hidden"></div>

                <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                    <p style="opacity:0.9;">Saldo Atual</p>
                    <h1 style="font-size:2.5rem;" id="dash-bal">R$ 0,00</h1>
                    <div class="flex justify-between" style="font-size:0.85rem; margin-top:10px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
                        <span><i class="fa-solid fa-arrow-up"></i> Receita: <span id="dash-inc">0,00</span></span>
                        <span><i class="fa-solid fa-arrow-down"></i> Despesa: <span id="dash-exp">0,00</span></span>
                    </div>
                </div>

                <!-- Bot√£o Nota Fiscal -->
                <div id="nf-shortcut" class="hidden" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="app.openNFLink()">
                        <i class="fa-solid fa-file-invoice"></i> Emitir Nota Fiscal (Emissor Nacional)
                    </button>
                </div>

                <!-- Bot√£o DAS -->
                <div id="das-shortcut" class="hidden" style="margin-bottom: 15px;">
                    <button class="btn btn-warning" onclick="app.openDASLink()">
                        <i class="fa-solid fa-barcode"></i> Pagar DAS (MEI)
                    </button>
                </div>

                <h3>Hist√≥rico</h3>
                <div id="list-recent"></div>
                <div id="empty-state" class="hidden" style="text-align:center; padding:30px; color:var(--text-muted);">
                    <p>Sem dados neste dispositivo.</p>
                </div>
            </div>

            <!-- VIEW: CADASTROS -->
            <div id="view-registers" class="hidden">
                <h2>Cadastros</h2>
                <div class="tab-menu">
                    <button class="tab-btn active" onclick="app.setRegTab('clients')">Clientes</button>
                    <button class="tab-btn" onclick="app.setRegTab('suppliers')">Fornecedores</button>
                    <button class="tab-btn" onclick="app.setRegTab('products')">Produtos</button>
                    <button class="tab-btn" onclick="app.setRegTab('services')">Servi√ßos</button>
                </div>

                <!-- Bot√µes Espec√≠ficos da Aba -->
                <div class="flex justify-between" style="margin-bottom: 15px;">
                    <h3 id="reg-title">Lista</h3>
                    <div class="flex" style="gap:5px;">
                        <!-- Bot√£o Lista de Compras (S√≥ aparece em Produtos) -->
                        <button id="btn-shopping-list" class="btn-warning btn-sm hidden" onclick="app.openShoppingList()">
                            <i class="fa-solid fa-cart-shopping"></i> Lista Compras
                        </button>
                        <button class="btn-primary btn-sm" onclick="app.openRegModal()"><i class="fa-solid fa-plus"></i> Adicionar</button>
                    </div>
                </div>

                <div id="reg-list"></div>
            </div>

            <!-- VIEW: CONFIGURA√á√ïES -->
            <div id="view-settings" class="hidden">
                <h2>Configura√ß√µes</h2>
                
                <div class="card">
                    <h3><i class="fa-solid fa-shop"></i> Modo Comerciante</h3>
                    <div class="flex justify-between" style="margin-top:10px;">
                        <span style="font-size:0.9rem; color:var(--text-muted);">Sou Comerciante (Vendo Produtos)</span>
                        <label class="switch">
                            <input type="checkbox" id="conf-merchant-mode" onchange="app.toggleMerchantMode()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-id-card"></i> Dados da Empresa</h3>
                    <button class="btn btn-outline" onclick="app.openProfileModal()"><i class="fa-solid fa-pen"></i> Editar Dados</button>
                    <button class="btn btn-outline" onclick="app.openPassModal()"><i class="fa-solid fa-lock"></i> Alterar Senha</button>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-folder-open"></i> Fiscal & Docs</h3>
                    
                    <!-- Link Emissor NF -->
                    <label class="form-label">Link Emissor Nacional (NF):</label>
                    <div class="flex" style="gap:5px;">
                        <input type="text" id="conf-nf-link" class="auth-input" placeholder="https://www.nfse.gov.br/EmissorNacional" style="margin:0;">
                        <button class="btn-secondary btn-sm" onclick="app.saveNFLink()">Salvar</button>
                    </div>
                    
                    <!-- Link Pagamento DAS -->
                    <label class="form-label">Link Pagamento DAS:</label>
                    <div class="flex" style="gap:5px;">
                        <input type="text" id="conf-das-link" class="auth-input" placeholder="https://www8.receita.fazenda.gov.br..." style="margin:0;">
                        <button class="btn-secondary btn-sm" onclick="app.saveDASLink()">Salvar</button>
                    </div>

                    <p style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">Links r√°pidos para acesso ao governo.</p>
                    <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
                    <button class="btn btn-outline" onclick="app.downloadManual()"><i class="fa-solid fa-file-pdf"></i> Baixar Manual/PDF</button>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-cloud-arrow-down"></i> Seguran√ßa</h3>
                    <button class="btn btn-dark" onclick="app.backupData()"><i class="fa-solid fa-download"></i> Baixar Backup</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-upload"></i> Restaurar</button>
                    <input type="file" id="file-input" accept=".json" class="hidden" onchange="app.restoreData(this)">
                </div>

                <div class="card">
                    <p id="conf-email" style="text-align:center; margin-bottom:10px; color:var(--text-muted);">...</p>
                    <button class="btn btn-danger" onclick="app.logout()">Sair</button>
                </div>

                <div class="app-footer">
                    <p>Desenvolvido por <a href="https://www.websitelog.com.br" target="_blank" class="website-link">Websitelog</a></p>
                    <div class="contact-links">
                        <a href="mailto:websitelogx@gmail.com"><i class="fa-solid fa-envelope"></i></a>
                        <a href="https://wa.me/5534997824990" target="_blank" style="color:#25D366"><i class="fa-brands fa-whatsapp"></i></a>
                    </div>
                    
                    <div class="donation-box">
                        <p>
                            Este app √© gratuito e sem an√∫ncios. Se quiser apoiar a manuten√ß√£o, contribua via PIX. Simples, claro e honesto.
                        </p>
                        <button class="btn btn-primary" onclick="app.copyPix()" style="width:auto; margin:0 auto; font-size:0.9rem; padding:8px 20px;">
                            <i class="fa-brands fa-pix"></i> Apoiar / Copiar Chave
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.navTo('home', this)"><i class="fa-solid fa-chart-pie"></i>In√≠cio</button>
            <button class="nav-item" onclick="app.navTo('registers', this)"><i class="fa-solid fa-address-book"></i>Cadastros</button>
            <button class="nav-item" onclick="app.navTo('settings', this)"><i class="fa-solid fa-user-gear"></i>Config</button>
        </nav>
    </section>

    <!-- MODAL: NOVA TRANSA√á√ÉO (COM RADIOS) -->
    <div id="modal-tx" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-tx')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Novo Lan√ßamento</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-tx')"></i></div>
            
            <!-- Indicador de Tipo (Visual) -->
            <div class="type-switch">
                <div class="type-opt active inc" id="opt-inc" onclick="app.setType('income')">Entrada</div>
                <div class="type-opt" id="opt-exp" onclick="app.setType('expense')">Sa√≠da</div>
            </div>

            <!-- Area de Op√ß√µes para Comerciante -->
            <div id="merchant-options" class="hidden">
                <div class="radio-group">
                    <label class="radio-item">
                        <input type="radio" name="tx-action" value="sale" onclick="app.handleStockAction('sale')">
                        <strong>Venda de Mercadoria</strong> (Baixar Estoque)
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="tx-action" value="buy" onclick="app.handleStockAction('buy')">
                        <strong>Compra de Mercadoria</strong> (Adicionar Estoque)
                    </label>
                    <label class="radio-item">
                        <input type="radio" name="tx-action" value="other" checked onclick="app.handleStockAction('other')">
                        <strong>Outro</strong> (Conta, Servi√ßo, etc.)
                    </label>
                </div>

                <!-- Detalhes do Produto (Aparece na Venda/Compra) -->
                <div id="tx-prod-details" class="hidden" style="margin-top:10px; padding:10px; background:#f8fafc; border-radius:10px; border:1px solid #e2e8f0;">
                    <label class="form-label">Produto</label>
                    <select id="tx-prod-select" class="auth-input" onchange="app.onTxProductChange()"></select>
                    
                    <div class="flex" style="gap:10px;">
                        <div>
                            <label class="form-label">Qtd</label>
                            <input type="number" id="tx-prod-qty" class="auth-input" value="1" min="1" oninput="app.calcTxTotal()">
                        </div>
                        <div>
                            <label class="form-label">Pre√ßo Unit.</label>
                            <input type="number" id="tx-prod-price" class="auth-input" oninput="app.calcTxTotal()" style="background:#fff;">
                        </div>
                    </div>
                </div>
            </div>

            <label class="form-label">Valor Total (R$)</label>
            <input type="number" id="tx-val" class="auth-input" step="0.01" style="font-size:1.4rem; font-weight:bold;">
            
            <label class="form-label">Categoria</label>
            <select id="tx-cat" class="auth-input"></select>
            
            <label class="form-label">Data</label>
            <input type="date" id="tx-date" class="auth-input">
            
            <label class="form-label">Descri√ß√£o (Opcional)</label>
            <input type="text" id="tx-desc" class="auth-input" placeholder="Detalhes">
            
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveTx()">Salvar</button>
        </div>
    </div>

    <!-- MODAL: CADASTRO GEN√âRICO -->
    <div id="modal-reg" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-reg')">
        <div class="modal-content">
            <div class="flex justify-between"><h2 id="reg-modal-title">Novo Item</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-reg')"></i></div>
            <label class="form-label">Nome / T√≠tulo</label>
            <input type="text" id="reg-name" class="auth-input">
            <div id="reg-fields-extra"></div>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveRegister()">Salvar Cadastro</button>
        </div>
    </div>

    <!-- MODAL: MOVIMENTA√á√ÉO DE ESTOQUE (AVULSA) -->
    <div id="modal-stock" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-stock')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Movimentar Estoque</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-stock')"></i></div>
            <p id="stock-prod-name" style="text-align:center; font-weight:bold; margin-bottom:10px; color:var(--primary-dark);">Produto X</p>
            <div class="type-switch">
                <div class="type-opt active inc" id="stk-inc" onclick="app.setStockType('in')">Entrada (Compra)</div>
                <div class="type-opt" id="stk-exp" onclick="app.setStockType('out')">Sa√≠da (Venda)</div>
            </div>
            <label class="form-label">Quantidade</label>
            <input type="number" id="stk-qty" class="auth-input" style="font-size:1.5rem; text-align:center;" placeholder="0">
            <label class="form-label">Motivo</label>
            <select id="stk-reason" class="auth-input">
                <option value="Compra">Compra / Reposi√ß√£o</option>
                <option value="Devolu√ß√£o">Devolu√ß√£o</option>
            </select>
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.saveStockMovement()">Confirmar</button>
        </div>
    </div>

    <!-- MODAL: LISTA DE COMPRAS -->
    <div id="modal-shopping" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-shopping')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Lista de Compras</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-shopping')"></i></div>
            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;">Itens abaixo do estoque m√≠nimo.</p>
            <div id="shopping-list-content" style="max-height:300px; overflow-y:auto; border:1px solid var(--border); border-radius:10px; padding:10px; margin-bottom:15px;"></div>
            <button class="btn btn-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i> Imprimir / Salvar PDF</button>
        </div>
    </div>

    <!-- MODAIS DE PERFIL E SENHA -->
    <div id="modal-profile" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-profile')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Editar Dados</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-profile')"></i></div>
            <label class="form-label">Nome Completo</label><input type="text" id="edit-name" class="auth-input">
            <label class="form-label">Nome Fantasia</label><input type="text" id="edit-fantasy" class="auth-input">
            <label class="form-label">CPF/CNPJ</label><input type="tel" id="edit-doc" class="auth-input">
            <button class="btn btn-primary" onclick="app.saveProfile()">Atualizar</button>
        </div>
    </div>
    <div id="modal-pass" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal('modal-pass')">
        <div class="modal-content">
            <div class="flex justify-between"><h2>Alterar Senha</h2><i class="fa-solid fa-xmark" onclick="app.closeModal('modal-pass')"></i></div>
            <label class="form-label">Nova Senha</label><input type="password" id="new-pass" class="auth-input">
            <label class="form-label">Confirmar</label><input type="password" id="conf-pass" class="auth-input">
            <button class="btn btn-danger" onclick="app.changePassword()">Confirmar</button>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIGURA√á√ÉO
        const firebaseConfig = {
            apiKey: "AIzaSyCijldF4haJzh0nzu4fbPYGHJadyYuqTP4",
            authDomain: "projmei.firebaseapp.com",
            projectId: "projmei",
            storageBucket: "projmei.firebasestorage.app",
            messagingSenderId: "39066795540",
            appId: "1:39066795540:web:edc72cedb442daee423101",
            measurementId: "G-PE631DFGE0"
        };
        const SEU_LINK_PDF = "https://drive.google.com/file/d/1gMocDMAey8q35-bcJsRip7Zm0v2mCrMS/view?usp=sharing"; 
        const DEFAULT_DAS_LINK = "https://www8.receita.fazenda.gov.br/SimplesNacional/Aplicacoes/ATSPO/pgmei.app/Identificacao";

        class App {
            constructor() {
                this.auth = null;
                this.user = null;
                
                // Dados Locais
                this.txs = [];
                this.profile = {}; 
                this.settings = { nfLink: '', dasLink: '', merchantMode: false }; 
                this.clients = [];
                this.suppliers = [];
                this.products = [];
                this.services = [];
                this.stockMovements = []; 

                this.isRegister = false;
                this.curType = 'income';
                this.curRegTab = 'clients'; 
                this.editIdx = null; 
                this.stockIdx = null; 
                this.stockType = 'in'; 
                this.txStockAction = 'other'; // 'sale', 'buy', 'other'

                this.categories = {
                    income: ['Venda de Produto', 'Presta√ß√£o de Servi√ßo', 'Outras Receitas'],
                    expense: ['Compra de Mercadoria', 'Material de Uso', 'Aluguel', '√Ågua/Luz/Internet', 'Imposto (DAS)', 'Transporte', 'Retirada Pessoal', 'Outras Despesas']
                };

                this.initFirebase();
            }

            initFirebase() {
                if (!firebaseConfig.apiKey) {
                    document.getElementById('config-warning').classList.remove('hidden');
                    return;
                }
                const app = initializeApp(firebaseConfig);
                this.auth = getAuth(app);
                onAuthStateChanged(this.auth, (user) => {
                    if (user) {
                        this.user = user;
                        this.onLoginSuccess();
                    } else {
                        this.user = null;
                        this.showAuth();
                    }
                });
            }

            // --- AUTH ---
            async handleAuth() {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;
                const name = document.getElementById('auth-name').value;
                try {
                    if (this.isRegister) {
                        if(!name) return alert("Digite seu nome.");
                        const cred = await createUserWithEmailAndPassword(this.auth, email, pass);
                        await updateProfile(cred.user, { displayName: name });
                    } else {
                        await signInWithEmailAndPassword(this.auth, email, pass);
                    }
                } catch (e) { alert("Erro: " + e.message); }
            }

            toggleAuthMode() {
                this.isRegister = !this.isRegister;
                document.getElementById('reg-fields').classList.toggle('hidden');
                document.getElementById('btn-auth').innerText = this.isRegister ? "Cadastrar" : "Entrar";
                document.getElementById('link-toggle').innerText = this.isRegister ? "J√° tenho conta" : "Criar nova conta";
            }

            logout() { signOut(this.auth); }
            showAuth() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }

            // --- DATA LOAD ---
            onLoginSuccess() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('conf-email').innerText = this.user.email;

                const uid = this.user.uid;
                // Carregar configura√ß√µes primeiro para ver o link padr√£o
                const defaultSettings = JSON.stringify({ 
                    nfLink: "https://www.nfse.gov.br/EmissorNacional", 
                    dasLink: DEFAULT_DAS_LINK,
                    merchantMode: false 
                });
                
                this.settings = JSON.parse(localStorage.getItem(`mei_settings_${uid}`) || defaultSettings);
                // Garantir que dasLink exista se for um usu√°rio antigo
                if(!this.settings.dasLink) this.settings.dasLink = DEFAULT_DAS_LINK;

                this.txs = JSON.parse(localStorage.getItem(`mei_data_${uid}`) || '[]');
                this.profile = JSON.parse(localStorage.getItem(`mei_profile_${uid}`) || '{"fantasy":"","doc":""}');
                this.clients = JSON.parse(localStorage.getItem(`mei_clients_${uid}`) || '[]');
                this.suppliers = JSON.parse(localStorage.getItem(`mei_suppliers_${uid}`) || '[]');
                this.products = JSON.parse(localStorage.getItem(`mei_products_${uid}`) || '[]');
                this.services = JSON.parse(localStorage.getItem(`mei_services_${uid}`) || '[]');
                this.stockMovements = JSON.parse(localStorage.getItem(`mei_stock_${uid}`) || '[]');

                // Atualizar switch do Merchant Mode
                document.getElementById('conf-merchant-mode').checked = this.settings.merchantMode || false;

                this.render();
                this.renderHeader();
                this.checkNFLink();
                this.checkDASLink();
                this.checkDASAlert(); // NOVO: Verifica datas para alerta
            }

            renderHeader() {
                document.getElementById('head-name').innerText = this.user.displayName || "Usu√°rio";
                document.getElementById('head-fantasy').innerText = this.profile.fantasy || "Minha Empresa";
                document.getElementById('conf-nf-link').value = this.settings.nfLink || '';
                document.getElementById('conf-das-link').value = this.settings.dasLink || '';
            }

            // --- L√≥gica de Alerta DAS e "Email" Simulado ---
            checkDASAlert() {
                const today = new Date().getDate();
                const el = document.getElementById('das-alert');
                
                // 1. Alert Box no Topo (Entre 15 e 20)
                if (today >= 15 && today <= 19) {
                    el.className = 'alert-das das-warning';
                    el.innerText = 'üìÖ Lembrete MEI: O DAS vence dia 20!';
                    el.classList.remove('hidden');
                } else if (today === 20) {
                    el.className = 'alert-das das-urgent';
                    el.innerText = 'üö® Seu DAS vence hoje!';
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }

                // 2. Simula√ß√£o de "Email" no dia 17
                if (today === 17) {
                    const emailKey = `das_email_alert_${new Date().toDateString()}_${this.user.uid}`;
                    const alreadySent = localStorage.getItem(emailKey);
                    
                    if (!alreadySent) {
                        const companyName = this.profile.fantasy || "Sua Empresa";
                        // Exibe um alerta simulando o email
                        alert(`${companyName}, lembrete: dia 20 √© o √∫ltimo dia para pagar o DAS`);
                        // Marca como enviado hoje para n√£o repetir
                        localStorage.setItem(emailKey, 'true');
                    }
                }
            }

            // --- CONFIGS: MERCHANT MODE ---
            toggleMerchantMode() {
                this.settings.merchantMode = document.getElementById('conf-merchant-mode').checked;
                localStorage.setItem(`mei_settings_${this.user.uid}`, JSON.stringify(this.settings));
                alert(this.settings.merchantMode ? "Modo Comerciante Ativado!" : "Modo Simples Ativado.");
            }

            // --- CADASTROS ---
            setRegTab(tab) {
                this.curRegTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                const titles = { clients: 'Clientes', suppliers: 'Fornecedores', products: 'Produtos', services: 'Servi√ßos' };
                document.getElementById('reg-title').innerText = titles[tab];
                
                const tabs = ['clients', 'suppliers', 'products', 'services'];
                document.querySelectorAll('.tab-btn')[tabs.indexOf(tab)].classList.add('active');

                if(tab === 'products') document.getElementById('btn-shopping-list').classList.remove('hidden');
                else document.getElementById('btn-shopping-list').classList.add('hidden');

                this.renderRegList();
            }

            renderRegList() {
                const list = document.getElementById('reg-list');
                list.innerHTML = '';
                let data = [];
                if(this.curRegTab === 'clients') data = this.clients;
                if(this.curRegTab === 'suppliers') data = this.suppliers;
                if(this.curRegTab === 'products') data = this.products;
                if(this.curRegTab === 'services') data = this.services;

                if(data.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:var(--text-muted); padding:20px;">Nenhum item cadastrado.</p>';
                    return;
                }

                data.forEach((item, idx) => {
                    let subInfo = '';
                    let stockBadge = '';

                    if(this.curRegTab === 'products') {
                        subInfo = `R$ ${parseFloat(item.price).toFixed(2)}`;
                        if(item.supplier) subInfo += ` | F: ${item.supplier}`;
                        
                        const curr = parseInt(item.currentStock || 0);
                        const min = parseInt(item.minStock || 0);
                        let colorClass = 'stock-ok';
                        if(curr <= min) colorClass = 'stock-crit';
                        else if(curr <= min * 1.5) colorClass = 'stock-low';
                        
                        stockBadge = `<span class="badge-stock ${colorClass}">Est: ${curr}</span>`;
                    }
                    else if(this.curRegTab === 'services') subInfo = `R$ ${parseFloat(item.price).toFixed(2)}`;
                    else subInfo = item.phone || item.doc || '-';

                    list.innerHTML += `
                    <div class="tx-item">
                        <div>
                            <strong>${item.name}</strong> ${stockBadge}<br>
                            <small style="color:var(--text-muted)">${subInfo}</small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            ${this.curRegTab === 'products' ? `<button class="btn-outline btn-sm" onclick="app.openStockModal(${idx})" title="Movimentar Estoque"><i class="fa-solid fa-box"></i></button>` : ''}
                            <button class="btn-outline btn-sm" onclick="app.openRegModal(${idx})" style="color:var(--primary);"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-outline btn-sm" onclick="app.deleteRegister(${idx})" style="color:var(--danger);"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`;
                });
            }

            openRegModal(idx = null) {
                this.editIdx = idx; 
                document.getElementById('reg-name').value = '';
                const extra = document.getElementById('reg-fields-extra');
                extra.innerHTML = '';

                let data = null;
                if (idx !== null) {
                    if(this.curRegTab === 'clients') data = this.clients[idx];
                    else if(this.curRegTab === 'suppliers') data = this.suppliers[idx];
                    else if(this.curRegTab === 'products') data = this.products[idx];
                    else data = this.services[idx];
                    document.getElementById('reg-name').value = data.name;
                }

                if(this.curRegTab === 'products') {
                    document.getElementById('reg-modal-title').innerText = idx !== null ? "Editar Produto" : "Novo Produto";
                    let supOptions = '<option value="">Sem Fornecedor</option>';
                    this.suppliers.forEach(s => { supOptions += `<option value="${s.name}">${s.name}</option>`; });

                    extra.innerHTML = `
                        <div class="flex" style="gap:10px;">
                            <div><label class="form-label">Pre√ßo Venda</label><input type="number" id="reg-price" class="auth-input" step="0.01"></div>
                            <div><label class="form-label">Custo</label><input type="number" id="reg-cost" class="auth-input" step="0.01"></div>
                        </div>
                        <div class="flex" style="gap:10px;">
                            <div><label class="form-label">Est. Atual</label><input type="number" id="reg-curr-stk" class="auth-input"></div>
                            <div><label class="form-label">Est. M√≠nimo</label><input type="number" id="reg-min-stk" class="auth-input"></div>
                            <div><label class="form-label">Est. Ideal</label><input type="number" id="reg-ideal-stk" class="auth-input"></div>
                        </div>
                        <label class="form-label">Fornecedor</label>
                        <select id="reg-supplier" class="auth-input">${supOptions}</select>
                    `;
                    if(idx !== null) {
                        setTimeout(() => {
                            document.getElementById('reg-price').value = data.price;
                            document.getElementById('reg-cost').value = data.cost;
                            document.getElementById('reg-supplier').value = data.supplier || '';
                            document.getElementById('reg-curr-stk').value = data.currentStock || 0;
                            document.getElementById('reg-min-stk').value = data.minStock || 0;
                            document.getElementById('reg-ideal-stk').value = data.idealStock || 0;
                        }, 50);
                    }
                } else if(this.curRegTab === 'services') {
                    document.getElementById('reg-modal-title').innerText = idx !== null ? "Editar Servi√ßo" : "Novo Servi√ßo";
                    extra.innerHTML = `
                        <label class="form-label">Pre√ßo de Venda (R$)</label><input type="number" id="reg-price" class="auth-input" step="0.01">
                        <label class="form-label">Custo (Opcional)</label><input type="number" id="reg-cost" class="auth-input" step="0.01">
                    `;
                    if(idx !== null) {
                        setTimeout(() => {
                            document.getElementById('reg-price').value = data.price;
                            document.getElementById('reg-cost').value = data.cost;
                        }, 50);
                    }
                } else {
                    document.getElementById('reg-modal-title').innerText = "Novo Cadastro";
                    extra.innerHTML = `
                        <label class="form-label">Telefone / WhatsApp</label><input type="tel" id="reg-phone" class="auth-input">
                        <label class="form-label">CPF / CNPJ</label><input type="text" id="reg-doc" class="auth-input">
                    `;
                    if(idx !== null) {
                        setTimeout(() => {
                            document.getElementById('reg-phone').value = data.phone;
                            document.getElementById('reg-doc').value = data.doc;
                        }, 50);
                    }
                }
                document.getElementById('modal-reg').classList.remove('hidden');
            }

            saveRegister() {
                const name = document.getElementById('reg-name').value;
                if(!name) return alert("Nome √© obrigat√≥rio.");

                let newItem = { name };

                if(this.curRegTab === 'products') {
                    newItem.price = document.getElementById('reg-price').value || 0;
                    newItem.cost = document.getElementById('reg-cost').value || 0;
                    newItem.supplier = document.getElementById('reg-supplier').value || '';
                    newItem.currentStock = parseInt(document.getElementById('reg-curr-stk').value || 0);
                    newItem.minStock = parseInt(document.getElementById('reg-min-stk').value || 0);
                    newItem.idealStock = parseInt(document.getElementById('reg-ideal-stk').value || 0);
                    
                    if (this.editIdx !== null) this.products[this.editIdx] = newItem;
                    else this.products.push(newItem);
                    localStorage.setItem(`mei_products_${this.user.uid}`, JSON.stringify(this.products));

                } else if (this.curRegTab === 'services') {
                    newItem.price = document.getElementById('reg-price').value || 0;
                    newItem.cost = document.getElementById('reg-cost').value || 0;
                    if (this.editIdx !== null) this.services[this.editIdx] = newItem;
                    else this.services.push(newItem);
                    localStorage.setItem(`mei_services_${this.user.uid}`, JSON.stringify(this.services));

                } else {
                    newItem.phone = document.getElementById('reg-phone').value || '';
                    newItem.doc = document.getElementById('reg-doc').value || '';
                    const arr = this.curRegTab === 'clients' ? this.clients : this.suppliers;
                    if (this.editIdx !== null) arr[this.editIdx] = newItem;
                    else arr.push(newItem);
                    localStorage.setItem(`mei_${this.curRegTab}_${this.user.uid}`, JSON.stringify(arr));
                }
                this.closeModal('modal-reg');
                this.renderRegList();
            }

            deleteRegister(idx) {
                if(!confirm("Excluir item?")) return;
                const arr = this.curRegTab === 'clients' ? this.clients : (this.curRegTab === 'suppliers' ? this.suppliers : (this.curRegTab === 'products' ? this.products : this.services));
                arr.splice(idx, 1);
                localStorage.setItem(`mei_${this.curRegTab}_${this.user.uid}`, JSON.stringify(arr));
                this.renderRegList();
            }

            // --- ESTOQUE ---
            openStockModal(idx) {
                this.stockIdx = idx;
                const p = this.products[idx];
                document.getElementById('stock-prod-name').innerText = p.name;
                document.getElementById('stk-qty').value = '';
                this.setStockType('in');
                document.getElementById('modal-stock').classList.remove('hidden');
            }

            setStockType(type) {
                this.stockType = type;
                const inc = document.getElementById('stk-inc');
                const exp = document.getElementById('stk-exp');
                const reason = document.getElementById('stk-reason');
                
                if(type === 'in') {
                    inc.classList.add('active'); exp.classList.remove('active');
                    reason.innerHTML = '<option value="Compra">Compra</option><option value="Devolu√ß√£o">Devolu√ß√£o Cliente</option>';
                } else {
                    exp.classList.add('active'); inc.classList.remove('active');
                    reason.innerHTML = '<option value="Venda">Venda</option><option value="Perda">Perda / Quebra</option><option value="Uso">Uso Interno</option>';
                }
            }

            saveStockMovement() {
                const qty = parseInt(document.getElementById('stk-qty').value);
                const reason = document.getElementById('stk-reason').value;
                if(!qty || qty <= 0) return alert("Quantidade inv√°lida.");

                const p = this.products[this.stockIdx];
                const oldStock = parseInt(p.currentStock || 0);
                
                if(this.stockType === 'in') p.currentStock = oldStock + qty;
                else p.currentStock = Math.max(0, oldStock - qty);

                this.stockMovements.push({
                    date: new Date().toISOString(), product: p.name, type: this.stockType,
                    qty: qty, reason: reason, newStock: p.currentStock
                });

                localStorage.setItem(`mei_products_${this.user.uid}`, JSON.stringify(this.products));
                localStorage.setItem(`mei_stock_${this.user.uid}`, JSON.stringify(this.stockMovements));
                
                alert("Estoque atualizado!");
                this.closeModal('modal-stock');
                this.renderRegList();
            }

            // --- LISTA DE COMPRAS ---
            openShoppingList() {
                const listDiv = document.getElementById('shopping-list-content');
                listDiv.innerHTML = '';
                let toBuy = this.products.filter(p => (parseInt(p.currentStock||0) <= parseInt(p.minStock||0)));
                if(toBuy.length === 0) listDiv.innerHTML = '<p>Tudo certo! Nenhum produto abaixo do m√≠nimo.</p>';
                else {
                    let html = '<table style="width:100%; font-size:0.85rem; border-collapse:collapse;">';
                    html += '<tr style="text-align:left; border-bottom:1px solid #ddd;"><th>Produto</th><th>Atual</th><th>Comprar</th></tr>';
                    toBuy.forEach(p => {
                        const ideal = parseInt(p.idealStock || 0);
                        const curr = parseInt(p.currentStock || 0);
                        const buyQty = ideal > curr ? (ideal - curr) : 0;
                        html += `<tr><td style="padding:5px;">${p.name}<br><small style="color:var(--text-muted)">${p.supplier||''}</small></td><td style="padding:5px; color:red;">${curr}</td><td style="padding:5px; font-weight:bold;">${buyQty > 0 ? buyQty : '-'}</td></tr>`;
                    });
                    html += '</table>';
                    listDiv.innerHTML = html;
                }
                document.getElementById('modal-shopping').classList.remove('hidden');
            }

            // --- CONFIGS & EXTRAS ---
            saveNFLink() {
                this.settings.nfLink = document.getElementById('conf-nf-link').value;
                localStorage.setItem(`mei_settings_${this.user.uid}`, JSON.stringify(this.settings));
                alert("Link NF Salvo!");
                this.checkNFLink();
            }
            saveDASLink() {
                this.settings.dasLink = document.getElementById('conf-das-link').value;
                localStorage.setItem(`mei_settings_${this.user.uid}`, JSON.stringify(this.settings));
                alert("Link DAS Salvo!");
                this.checkDASLink();
            }
            
            checkNFLink() {
                const el = document.getElementById('nf-shortcut');
                if(this.settings.nfLink && this.settings.nfLink.length > 5) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }
            checkDASLink() {
                const el = document.getElementById('das-shortcut');
                if(this.settings.dasLink && this.settings.dasLink.length > 5) el.classList.remove('hidden');
                else el.classList.add('hidden');
            }

            openNFLink() { if(this.settings.nfLink) window.open(this.settings.nfLink, '_blank'); }
            openDASLink() { if(this.settings.dasLink) window.open(this.settings.dasLink, '_blank'); }

            downloadManual() { if(!SEU_LINK_PDF) return alert("Configure o PDF"); window.open(SEU_LINK_PDF, '_blank'); }

            openProfileModal() {
                document.getElementById('edit-name').value = this.user.displayName || '';
                document.getElementById('edit-fantasy').value = this.profile.fantasy || '';
                document.getElementById('edit-doc').value = this.profile.doc || '';
                document.getElementById('modal-profile').classList.remove('hidden');
            }
            async saveProfile() {
                const newName = document.getElementById('edit-name').value;
                if(!newName) return alert("Nome obrigat√≥rio");
                try {
                    if(newName !== this.user.displayName) await updateProfile(this.user, {displayName: newName});
                    this.profile = { fantasy: document.getElementById('edit-fantasy').value, doc: document.getElementById('edit-doc').value };
                    localStorage.setItem(`mei_profile_${this.user.uid}`, JSON.stringify(this.profile));
                    alert("Atualizado!"); this.closeModal('modal-profile'); this.renderHeader();
                } catch(e) { alert("Erro: " + e.message); }
            }

            openPassModal() { document.getElementById('modal-pass').classList.remove('hidden'); }
            async changePassword() {
                const p1 = document.getElementById('new-pass').value;
                const p2 = document.getElementById('conf-pass').value;
                if(p1.length < 6 || p1!==p2) return alert("Senha inv√°lida ou n√£o confere.");
                try { await updatePassword(this.user, p1); alert("Senha alterada!"); this.logout(); }
                catch(e) { alert("Erro: " + e.message); }
            }

            // --- TRANSACTION (FINANCIAL + STOCK) ---
            openTxModal() {
                document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('tx-val').value = '';
                document.getElementById('tx-desc').value = '';
                
                // Reset Radios
                const radios = document.getElementsByName('tx-action');
                radios.forEach(r => r.checked = (r.value === 'other'));
                this.handleStockAction('other');
                
                this.setType('income'); 
                document.getElementById('modal-tx').classList.remove('hidden');
            }

            setType(type) {
                this.curType = type;
                document.getElementById('opt-inc').classList.toggle('active', type === 'income');
                document.getElementById('opt-exp').classList.toggle('active', type === 'expense');
                
                const select = document.getElementById('tx-cat');
                select.innerHTML = '';
                this.categories[type].forEach(c => { select.innerHTML += `<option value="${c}">${c}</option>`; });
                
                // Show Radio Options only if Merchant Mode is ON
                const merchantOpts = document.getElementById('merchant-options');
                if(this.settings.merchantMode) {
                    merchantOpts.classList.remove('hidden');
                    // Populate Product Select
                    const prodSel = document.getElementById('tx-prod-select');
                    prodSel.innerHTML = '<option value="">Selecione...</option>';
                    this.products.forEach((p, idx) => {
                        prodSel.innerHTML += `<option value="${idx}">${p.name} (R$ ${p.price})</option>`;
                    });
                } else {
                    merchantOpts.classList.add('hidden');
                }
            }

            handleStockAction(action) {
                this.txStockAction = action;
                const details = document.getElementById('tx-prod-details');
                const valInput = document.getElementById('tx-val');

                if(action === 'sale') {
                    this.setType('income'); // Force Income
                    details.classList.remove('hidden');
                    valInput.setAttribute('readonly', true);
                    valInput.style.background = "#eee";
                } else if (action === 'buy') {
                    this.setType('expense'); // Force Expense
                    details.classList.remove('hidden');
                    valInput.removeAttribute('readonly'); // Cost can change
                    valInput.style.background = "#fff";
                } else {
                    details.classList.add('hidden');
                    valInput.removeAttribute('readonly');
                    valInput.style.background = "#fff";
                }
            }

            onTxProductChange() {
                this.calcTxTotal();
            }

            calcTxTotal() {
                const idx = document.getElementById('tx-prod-select').value;
                if(idx === "") return;
                
                const qty = parseInt(document.getElementById('tx-prod-qty').value || 1);
                const prod = this.products[idx];
                
                // If Sale, use Sales Price. If Buy, try Cost Price (or 0)
                let price = 0;
                if(this.txStockAction === 'sale') price = parseFloat(prod.price || 0);
                else price = parseFloat(prod.cost || 0);
                
                document.getElementById('tx-prod-price').value = price.toFixed(2);
                
                // If sale, auto-calc total. If buy, user might edit total manually so we suggest only
                if(this.txStockAction === 'sale') {
                    document.getElementById('tx-val').value = (price * qty).toFixed(2);
                } else {
                    // For buy, only suggest if field is empty to not overwrite user input
                    if(document.getElementById('tx-val').value === "") {
                        document.getElementById('tx-val').value = (price * qty).toFixed(2);
                    }
                }
            }

            saveTx() {
                const val = parseFloat(document.getElementById('tx-val').value);
                const date = document.getElementById('tx-date').value;
                const cat = document.getElementById('tx-cat').value; 
                let desc = document.getElementById('tx-desc').value;

                if (!val || !date) return alert("Preencha valor e data");

                // STOCK LOGIC
                if(this.settings.merchantMode && this.txStockAction !== 'other') {
                    const prodIdx = document.getElementById('tx-prod-select').value;
                    const qty = parseInt(document.getElementById('tx-prod-qty').value);
                    
                    if(prodIdx === "" || !qty) return alert("Selecione o produto e quantidade.");
                    
                    const p = this.products[prodIdx];
                    const oldStock = parseInt(p.currentStock)||0;
                    
                    if(this.txStockAction === 'sale') {
                        p.currentStock = Math.max(0, oldStock - qty);
                        desc = `Venda: ${p.name} (x${qty}) - ${desc}`;
                        
                        // Log Stock Movement
                        this.stockMovements.push({
                            date: new Date().toISOString(), product: p.name, type: 'out',
                            qty: qty, reason: 'Venda Direta', newStock: p.currentStock
                        });

                    } else if (this.txStockAction === 'buy') {
                        p.currentStock = oldStock + qty;
                        desc = `Compra: ${p.name} (x${qty}) - ${desc}`;
                        
                        // Update Cost Price if changed? Optional. Let's keep simple.
                        
                        // Log Stock Movement
                        this.stockMovements.push({
                            date: new Date().toISOString(), product: p.name, type: 'in',
                            qty: qty, reason: 'Reposi√ß√£o', newStock: p.currentStock
                        });
                    }
                    
                    localStorage.setItem(`mei_products_${this.user.uid}`, JSON.stringify(this.products));
                    localStorage.setItem(`mei_stock_${this.user.uid}`, JSON.stringify(this.stockMovements));
                }

                // Financial Record
                this.txs.push({ 
                    id: Date.now(), type: this.curType, val, date, cat, desc 
                });
                localStorage.setItem(`mei_data_${this.user.uid}`, JSON.stringify(this.txs));
                
                this.closeModal('modal-tx');
                this.render();
                if(this.curRegTab === 'products') this.renderRegList();
            }

            render() {
                const list = document.getElementById('list-recent');
                list.innerHTML = '';
                let bal = 0, incTotal = 0, expTotal = 0;
                if (this.txs.length === 0) document.getElementById('empty-state').classList.remove('hidden');
                else {
                    document.getElementById('empty-state').classList.add('hidden');
                    this.txs.sort((a,b) => new Date(b.date) - new Date(a.date));
                    this.txs.forEach(tx => {
                        if(tx.type === 'income') { bal += tx.val; incTotal += tx.val; } 
                        else { bal -= tx.val; expTotal += tx.val; }
                        list.innerHTML += `<div class="tx-item"><div><strong>${tx.cat}</strong><br><small style="color:var(--text-muted)">${new Date(tx.date).toLocaleDateString()} ${tx.desc}</small></div><span class="${tx.type==='income'?'text-green':'text-red'}">${tx.type==='income'?'+':'-'} R$ ${tx.val.toFixed(2)}</span></div>`;
                    });
                }
                document.getElementById('dash-bal').innerText = `R$ ${bal.toFixed(2)}`;
                document.getElementById('dash-inc').innerText = incTotal.toFixed(2);
                document.getElementById('dash-exp').innerText = expTotal.toFixed(2);
            }

            closeModal(id) { document.getElementById(id).classList.add('hidden'); }
            navTo(viewId, btn) {
                ['home', 'registers', 'settings'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('view-'+viewId).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if(viewId === 'registers') this.renderRegList();
            }

            copyPix() { navigator.clipboard.writeText("b4648948-d0a8-4402-81f4-8a4047fcf4e5").then(()=>alert("Pix copiado ‚Äî agora √© s√≥ colar e pagar.")); }
            
            backupData() {
                const payload = { 
                    txs: this.txs, profile: this.profile, settings: this.settings,
                    clients: this.clients, suppliers: this.suppliers, products: this.products,
                    services: this.services, stockMovements: this.stockMovements
                };
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(payload));
                a.download = `backup_mei_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            }

            restoreData(input) {
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.txs) this.txs = json.txs; 
                        if(json.profile) this.profile = json.profile;
                        if(json.settings) this.settings = json.settings;
                        if(json.clients) this.clients = json.clients;
                        if(json.suppliers) this.suppliers = json.suppliers;
                        if(json.products) this.products = json.products;
                        if(json.services) this.services = json.services;
                        if(json.stockMovements) this.stockMovements = json.stockMovements;

                        const uid = this.user.uid;
                        localStorage.setItem(`mei_data_${uid}`, JSON.stringify(this.txs));
                        localStorage.setItem(`mei_profile_${uid}`, JSON.stringify(this.profile));
                        localStorage.setItem(`mei_settings_${uid}`, JSON.stringify(this.settings));
                        localStorage.setItem(`mei_clients_${uid}`, JSON.stringify(this.clients));
                        localStorage.setItem(`mei_suppliers_${uid}`, JSON.stringify(this.suppliers));
                        localStorage.setItem(`mei_products_${uid}`, JSON.stringify(this.products));
                        localStorage.setItem(`mei_services_${uid}`, JSON.stringify(this.services));
                        localStorage.setItem(`mei_stock_${uid}`, JSON.stringify(this.stockMovements));

                        this.render(); this.renderHeader(); this.checkNFLink(); this.checkDASLink();
                        alert("Restaurado!");
                    } catch(e) { alert("Arquivo inv√°lido"); }
                };
                reader.readAsText(file);
            }
        }
        window.app = new App();
    </script>
</body>
</html>