<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEI Simples - Gestão & Backup</title>
    
    <!-- Bibliotecas -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #00bf63; /* Verde Principal */
            --primary-dark: #00914b;
            --secondary: #5e17eb; /* Roxo Secundário */
            --bg-light: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-light); color: var(--text-main); height: 100vh; overflow-x: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .justify-between { justify-content: space-between; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 20px; }
        
        /* Botões */
        .btn { border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-dark { background: var(--text-main); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        
        /* Cards */
        .card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; }

        /* TELA DE LOGIN */
        #auth-screen { min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; background: var(--surface); position: fixed; top: 0; width: 100%; z-index: 9999; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-light); }

        /* TELA PRINCIPAL */
        #app-screen { padding-bottom: 90px; }
        header { background: var(--surface); padding: 15px 0; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* Lista Transações */
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border); }
        .tx-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; margin-right: 10px; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .text-green { color: var(--primary); }
        .text-red { color: var(--danger); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); padding: 10px 0; display: flex; justify-content: space-around; z-index: 100; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; background: none; border: none; cursor: pointer; }
        .nav-item i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); font-weight: 600; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; animation: slideUp 0.3s ease; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; margin-top: 10px; }
        .form-input, .form-select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-light); color: var(--text-main); font-family: inherit; font-size: 1rem; }

        /* Tipo Switch */
        .type-switch { display: flex; background: var(--bg-light); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .type-opt { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-muted); transition: 0.2s; }
        .type-opt.active.inc { background: var(--primary); color: white; }
        .type-opt.active.exp { background: var(--danger); color: white; }

        /* Backup Area */
        .backup-box { border: 2px dashed var(--border); padding: 20px; text-align: center; border-radius: 12px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- 1. TELA DE LOGIN -->
    <section id="auth-screen">
        <div style="text-align:center; max-width:400px; width:100%;">
            <i class="fa-solid fa-store" style="font-size:3.5rem; color:var(--primary); margin-bottom:10px;"></i>
            <h1>MEI Simples</h1>
            <p style="color:var(--text-muted); margin-bottom:20px;">Gestão Financeira & Backup</p>
            
            <form onsubmit="event.preventDefault(); app.handleLogin();">
                <!-- Register Fields -->
                <div id="reg-fields" class="hidden">
                    <input type="text" id="auth-name" class="auth-input" placeholder="Seu Nome">
                    <input type="text" id="auth-fantasy" class="auth-input" placeholder="Nome do Negócio (Fantasia)">
                    <input type="tel" id="auth-doc" class="auth-input" placeholder="CPF ou CNPJ">
                </div>
                <!-- Common -->
                <input type="email" id="auth-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="auth-pass" class="auth-input" placeholder="Senha" required>
                
                <button class="btn btn-primary" id="btn-auth">Entrar</button>
            </form>
            
            <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:0.85rem; color:var(--text-muted); cursor:pointer;">
                <span onclick="app.toggleAuthMode()" id="link-toggle">Criar conta</span>
            </div>
        </div>
    </section>

    <!-- 2. APP PRINCIPAL -->
    <section id="app-screen" class="hidden">
        <header>
            <div class="container flex justify-between">
                <div>
                    <h2 style="font-size:1rem;" id="head-fantasy">Minha Empresa</h2>
                    <p style="font-size:0.75rem; color:var(--text-muted);" id="head-name">Usuário</p>
                </div>
                <button onclick="app.openModal('income')" class="btn-primary" style="width:auto; padding:8px 15px; font-size:0.8rem; border-radius:20px;">
                    <i class="fa-solid fa-plus"></i> Novo
                </button>
            </div>
        </header>

        <main class="container" style="padding-top:20px;">
            
            <!-- DASHBOARD -->
            <div id="view-home">
                <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white;">
                    <p style="opacity:0.9; font-size:0.9rem;">Saldo Atual</p>
                    <h1 style="font-size:2.5rem; margin:5px 0;" id="dash-bal">R$ 0,00</h1>
                    <div class="flex justify-between" style="font-size:0.85rem; margin-top:10px; background:rgba(0,0,0,0.1); padding:10px; border-radius:10px;">
                        <span><i class="fa-solid fa-arrow-up"></i> Entradas: <span id="dash-inc">0,00</span></span>
                        <span><i class="fa-solid fa-arrow-down"></i> Saídas: <span id="dash-exp">0,00</span></span>
                    </div>
                </div>

                <div class="flex justify-between" style="margin-bottom:10px; align-items:center;">
                    <h3>Histórico Recente</h3>
                    <small style="color:var(--text-muted)" id="tx-count">0 registros</small>
                </div>
                <div id="list-recent"></div>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="app.navTo('finance')">Ver Extrato Completo</button>
            </div>

            <!-- FINANCEIRO (Lista Completa) -->
            <div id="view-finance" class="hidden">
                <h2 style="margin-bottom:15px;">Extrato Detalhado</h2>
                <div class="flex" style="gap:10px; margin-bottom:15px;">
                    <input type="month" id="filter-date" class="form-input" onchange="app.renderData()">
                    <button class="btn btn-secondary" style="width:auto;" onclick="app.renderData()"><i class="fa-solid fa-filter"></i></button>
                </div>
                <div id="list-full"></div>
            </div>

            <!-- CONFIGURAÇÕES & BACKUP -->
            <div id="view-settings" class="hidden">
                <h2>Configurações</h2>
                
                <div class="card">
                    <h3><i class="fa-solid fa-cloud-arrow-down"></i> Backup & Restore</h3>
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">
                        Salve seus dados no computador/celular e restaure quando quiser.
                    </p>
                    
                    <button class="btn btn-dark" onclick="app.backupData()">
                        <i class="fa-solid fa-download"></i> Fazer Backup (Baixar Arquivo)
                    </button>

                    <div class="backup-box" onclick="document.getElementById('file-input').click()">
                        <i class="fa-solid fa-upload" style="font-size:1.5rem; color:var(--text-muted)"></i>
                        <p style="margin-top:5px; font-size:0.9rem;">Toque para restaurar backup</p>
                        <input type="file" id="file-input" accept=".json" class="hidden" onchange="app.restoreData(this)">
                    </div>
                </div>

                <div class="card">
                    <h3><i class="fa-solid fa-user"></i> Dados da Conta</h3>
                    <p><strong>Nome:</strong> <span id="conf-name">-</span></p>
                    <p><strong>Fantasia:</strong> <span id="conf-fantasy">-</span></p>
                    <p><strong>CNPJ/CPF:</strong> <span id="conf-doc">-</span></p>
                    <button class="btn btn-danger" style="margin-top:15px;" onclick="app.logout()">
                        <i class="fa-solid fa-right-from-bracket"></i> Sair do App
                    </button>
                </div>
            </div>

        </main>

        <!-- MENU INFERIOR -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.navTo('home', this)"><i class="fa-solid fa-chart-pie"></i>Início</button>
            <button class="nav-item" onclick="app.navTo('finance', this)"><i class="fa-solid fa-list"></i>Extrato</button>
            <button class="nav-item" onclick="app.navTo('settings', this)"><i class="fa-solid fa-gear"></i>Ajustes</button>
        </nav>
    </section>

    <!-- MODAL DE CADASTRO -->
    <div id="modal-tx" class="modal-overlay hidden" onclick="if(event.target===this) app.closeModal()">
        <div class="modal-content">
            <div class="flex justify-between">
                <h2>Nova Movimentação</h2>
                <i class="fa-solid fa-xmark" onclick="app.closeModal()" style="font-size:1.5rem; padding:10px;"></i>
            </div>
            
            <!-- Seletor Tipo -->
            <div class="type-switch">
                <div class="type-opt active inc" id="opt-inc" onclick="app.setType('income')">Entrada (Receita)</div>
                <div class="type-opt" id="opt-exp" onclick="app.setType('expense')">Saída (Despesa)</div>
            </div>

            <div class="form-group">
                <label>Valor (R$)</label>
                <input type="number" id="tx-val" class="form-input" style="font-size:1.5rem; font-weight:bold;" step="0.01" placeholder="0,00">
            </div>

            <div class="form-group">
                <label>Data</label>
                <input type="date" id="tx-date" class="form-input">
            </div>

            <div class="form-group">
                <label>Categoria / Motivo</label>
                <select id="tx-cat" class="form-select">
                    <!-- Opções preenchidas via JS -->
                </select>
            </div>

            <div class="form-group">
                <label>Descrição (Opcional)</label>
                <input type="text" id="tx-desc" class="form-input" placeholder="Detalhes (ex: Cliente João)">
            </div>

            <button class="btn btn-primary" style="margin-top:20px;" onclick="app.saveTx()">Salvar Movimento</button>
        </div>
    </div>

    <script>
        class MeiApp {
            constructor() {
                this.user = null;
                this.txs = [];
                this.view = 'home';
                this.curType = 'income';
                this.isRegistering = false;
                
                // Categorias Padrão
                this.cats = {
                    income: ['Venda de Produto', 'Prestação de Serviço', 'Recebimento Atrasado', 'Outra Entrada'],
                    expense: ['Compra de Mercadoria', 'Material de Uso', 'Conta (Luz/Água/Net)', 'Aluguel', 'Imposto (DAS)', 'Transporte', 'Retirada Pessoal']
                };

                this.checkSession();
            }

            // --- AUTH ---
            toggleAuthMode() {
                this.isRegistering = !this.isRegistering;
                const el = document.getElementById('reg-fields');
                const btn = document.getElementById('btn-auth');
                const link = document.getElementById('link-toggle');
                
                if(this.isRegistering) {
                    el.classList.remove('hidden');
                    btn.innerText = "Cadastrar e Entrar";
                    link.innerText = "Já tenho conta";
                } else {
                    el.classList.add('hidden');
                    btn.innerText = "Entrar";
                    link.innerText = "Criar conta";
                }
            }

            handleLogin() {
                const email = document.getElementById('auth-email').value;
                const pass = document.getElementById('auth-pass').value;

                if(!email || !pass) return alert("Preencha email e senha");

                // Modo Local Simplificado
                const users = JSON.parse(localStorage.getItem('mei_users') || '[]');
                
                if (this.isRegistering) {
                    const name = document.getElementById('auth-name').value;
                    const fantasy = document.getElementById('auth-fantasy').value;
                    const doc = document.getElementById('auth-doc').value;
                    if(!name) return alert("Preencha seu nome");

                    const newUser = { email, pass, name, fantasy, doc, id: Date.now() };
                    users.push(newUser);
                    localStorage.setItem('mei_users', JSON.stringify(users));
                    this.login(newUser);
                } else {
                    const user = users.find(u => u.email === email && u.pass === pass);
                    if(user) this.login(user);
                    else alert("Dados incorretos.");
                }
            }

            login(user) {
                this.user = user;
                localStorage.setItem('mei_session', JSON.stringify(user));
                
                // Load Txs
                const data = localStorage.getItem(`mei_data_${user.id}`);
                this.txs = data ? JSON.parse(data) : [];

                // UI
                document.getElementById('head-fantasy').innerText = user.fantasy || "Meu Negócio";
                document.getElementById('head-name').innerText = user.name;
                document.getElementById('conf-name').innerText = user.name;
                document.getElementById('conf-fantasy').innerText = user.fantasy || "-";
                document.getElementById('conf-doc').innerText = user.doc || "-";

                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                
                // Init Date
                document.getElementById('filter-date').value = new Date().toISOString().slice(0,7);
                this.renderData();
            }

            checkSession() {
                const session = localStorage.getItem('mei_session');
                if(session) this.login(JSON.parse(session));
            }

            logout() {
                localStorage.removeItem('mei_session');
                location.reload();
            }

            // --- NAVIGATION ---
            navTo(viewId, btn) {
                ['home', 'finance', 'settings'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
                document.getElementById('view-'+viewId).classList.remove('hidden');
                
                if(btn) {
                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            }

            // --- MODAL & FORM ---
            openModal(type) {
                this.setType(type);
                document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('tx-val').value = '';
                document.getElementById('tx-desc').value = '';
                document.getElementById('modal-tx').classList.remove('hidden');
            }

            closeModal() { document.getElementById('modal-tx').classList.add('hidden'); }

            setType(type) {
                this.curType = type;
                const incBtn = document.getElementById('opt-inc');
                const expBtn = document.getElementById('opt-exp');
                const catSel = document.getElementById('tx-cat');

                if(type === 'income') {
                    incBtn.classList.add('active'); expBtn.classList.remove('active');
                } else {
                    expBtn.classList.add('active'); incBtn.classList.remove('active');
                }

                // Popular Categorias
                catSel.innerHTML = '';
                this.cats[type].forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c; opt.innerText = c;
                    catSel.appendChild(opt);
                });
            }

            saveTx() {
                const val = parseFloat(document.getElementById('tx-val').value);
                const date = document.getElementById('tx-date').value;
                const cat = document.getElementById('tx-cat').value;
                const desc = document.getElementById('tx-desc').value || cat;

                if(!val || !date) return alert("Preencha valor e data.");

                const tx = {
                    id: Date.now(),
                    type: this.curType,
                    val, date, cat, desc
                };

                this.txs.push(tx);
                this.saveData();
                this.closeModal();
                this.renderData();
            }

            saveData() {
                localStorage.setItem(`mei_data_${this.user.id}`, JSON.stringify(this.txs));
            }

            // --- RENDER ---
            renderData() {
                const listHome = document.getElementById('list-recent');
                const listFull = document.getElementById('list-full');
                listHome.innerHTML = ''; listFull.innerHTML = '';

                let bal = 0, inc = 0, exp = 0;

                // Ordenar por data
                const sorted = [...this.txs].sort((a,b) => new Date(b.date) - new Date(a.date));

                sorted.forEach((tx, i) => {
                    if(tx.type === 'income') { bal += tx.val; inc += tx.val; }
                    else { bal -= tx.val; exp += tx.val; }

                    const html = `
                        <div class="tx-item">
                            <div class="flex">
                                <div class="tx-icon ${tx.type==='income'?'bg-green':'bg-red'}">
                                    <i class="fa-solid ${tx.type==='income'?'fa-arrow-up':'fa-arrow-down'}"></i>
                                </div>
                                <div>
                                    <h4 style="font-size:0.9rem;">${tx.cat}</h4>
                                    <small style="color:var(--text-muted)">${new Date(tx.date).toLocaleDateString('pt-BR')} • ${tx.desc}</small>
                                </div>
                            </div>
                            <strong class="${tx.type==='income'?'text-green':'text-red'}">
                                ${tx.type==='income'?'+':'-'} ${tx.val.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}
                            </strong>
                        </div>
                    `;
                    
                    if(i < 5) listHome.innerHTML += html;
                    listFull.innerHTML += html;
                });

                // Dashboard Values
                document.getElementById('dash-bal').innerText = bal.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('dash-inc').innerText = inc.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('dash-exp').innerText = exp.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
                document.getElementById('tx-count').innerText = `${this.txs.length} registros`;
            }

            // --- BACKUP & RESTORE ---
            backupData() {
                if(this.txs.length === 0) return alert("Não há dados para salvar.");
                
                const backupObj = {
                    user: this.user,
                    transactions: this.txs,
                    generatedAt: new Date().toISOString()
                };

                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupObj));
                const downloadAnchorNode = document.createElement('a');
                
                // Formata Data no Nome do Arquivo (YYYY-MM-DD)
                const dateStr = new Date().toISOString().slice(0,10);
                const fileName = `backup_mei_${dateStr}.json`;
                
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", fileName);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            restoreData(input) {
                const file = input.files[0];
                if(!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.transactions && Array.isArray(json.transactions)) {
                            
                            if(confirm(`Restaurar backup de ${new Date(json.generatedAt).toLocaleDateString()}? Isso substituirá os dados atuais.`)) {
                                this.txs = json.transactions;
                                this.saveData();
                                this.renderData();
                                alert("Dados restaurados com sucesso!");
                            }

                        } else {
                            alert("Arquivo de backup inválido.");
                        }
                    } catch(err) {
                        alert("Erro ao ler arquivo.");
                    }
                };
                reader.readAsText(file);
            }
        }

        window.app = new MeiApp();
    </script>
</body>
</html>